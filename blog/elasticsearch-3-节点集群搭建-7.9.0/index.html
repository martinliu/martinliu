<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="高可靠性 3 节点的 ES 集群适用于各种应用场景"><meta name=keywords content="DevOps,Elastic Stack,Elasticsearch"><title>Elasticsearch 3 节点集群搭建 (7.9.0)</title><link rel=canonical href=https://martinliu.cn/blog/elasticsearch-3-%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-7.9.0/><link rel=stylesheet href=/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="Elasticsearch 3 节点集群搭建 (7.9.0)"><meta property="og:description" content="高可靠性 3 节点的 ES 集群适用于各种应用场景"><meta property="og:url" content="https://martinliu.cn/blog/elasticsearch-3-%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-7.9.0/"><meta property="og:site_name" content="Martin Liu's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Elastic Stack"><meta property="article:tag" content="Elasticsearch"><meta property="article:published_time" content="2020-08-27T13:54:46+08:00"><meta property="article:modified_time" content="2020-08-27T13:54:46+08:00"><meta property="og:image" content="https://martinliu.cn/images/abstract-6.jpg"><meta name=twitter:title content="Elasticsearch 3 节点集群搭建 (7.9.0)"><meta name=twitter:description content="高可靠性 3 节点的 ES 集群适用于各种应用场景"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://martinliu.cn/images/abstract-6.jpg"><link rel="shortcut icon" href=/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-749876-6","auto"),ga("send","pageview"))</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu1c7d893ce8aa46fc819d9e2ee56dab62_7023_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>☁️</span></figure><div class=site-meta><h1 class=site-name><a href=/>Martin Liu's Blog</a></h1><h2 class=site-description>Seniro Developer Advocate@Elastic, Founder of DevOps China</h2></div></header><ol class=social-menu><li><a href=https://github.com/martinliu/ target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/martinliu target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>首页</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg><span>关于</span></a></li><li><a href=/course/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>教程</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>搜索</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>归档</span></a></li><li><a href=/%E9%93%BE%E6%8E%A5/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>链接</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://martinliu.cn/ selected>中文</option><option value=https://martinliu.cn/en/>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#演示环境介绍>演示环境介绍</a></li><li><a href=#elasticsearch-安装脚本>Elasticsearch 安装脚本</a></li><li><a href=#elasticsearch-配置文件>Elasticsearch 配置文件</a></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/elasticsearch-3-%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-7.9.0/><img src=/images/abstract-6.jpg loading=lazy alt="Featured image of post Elasticsearch 3 节点集群搭建 (7.9.0)"></a></div><div class=article-details><header class=article-category><a href=/categories/devops/ style=background-color:#2a9d8f;color:#fff>DevOps</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/elasticsearch-3-%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-7.9.0/>Elasticsearch 3 节点集群搭建 (7.9.0)</a></h2><h3 class=article-subtitle>高可靠性 3 节点的 ES 集群适用于各种应用场景</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2020-08-27, Thursday</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><p>最近发布的 Elastic Stack 7.9 ，带来了很多新的特性。Elastic Agent 统一集成数据采集代理是一大亮点。另外还看增加了企业搜索、端点安全防护等组件。Ingest Manager 统一 Beat 配置管理功能让我们向 SaaS 风格的监控工具又迈进了一步。由代理端自行注册到后端，在后端统一纳管所有被管理服务器，将是一种以后非常通用的模式。这样做的好处是：将数据采集端点的配置工作量和复杂度降低到最低。Beats 的各种相关独立模块也在平行的发布，这种双轨模式也可以让用户更弹性的做出选择，能最大程度的保持旧版本部署环境管理模式的延续性。 Ingest manager 的前提条件是：后台 ES 需要启用 api key 安全，启用 ES 客户端的 HTTPS 访问。我们也可以看到这两个功能选项也有其非常广泛的应用需求。本文将用最简单的文字，向你描述一套 3 节点的 ES 集群的搭建方式，这套系统的核心特性如下：</p><ul><li>启用用户名和密码认证</li><li>启用集群内 es 节点间 transport.ssl 通讯加密</li><li>启用 es 的 http 客户端 http.ssl 加密通讯</li><li>安装脚本中包括创建数字证书的必要命令（没猜错的话，大部分人可能会在这一步花费大量时间）</li></ul><h2 id=演示环境介绍>演示环境介绍</h2><p>我使用的是本地的测试环境，环境配置如下：</p><ul><li>Mac OS</li><li>vagrant</li><li>virtualBox - CentOS 8</li><li>Elastic Stack 7.9.0</li><li>ip 和主机名分配见 Vagrantfile 文件</li><li>Vagrant 的 vagrant-hostsupdater 插件实现了 Mac OS 主机和所有虚拟机的 host 文件 DNS 解析的同步，保证所有相关虚拟机都可以解析其它虚拟机的 FQDN，尽量模拟生产环境。</li></ul><p>本文所使用的所有配置文件和安装脚本见：https://github.com/DevOps-Coach/elasticstack.git</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>➜  elasticstack git:(master) ✗ vagrant up es1 es2 es3
</span></span><span class=line><span class=cl>Bringing machine &#39;es1&#39; up with &#39;virtualbox&#39; provider...
</span></span><span class=line><span class=cl>Bringing machine &#39;es2&#39; up with &#39;virtualbox&#39; provider...
</span></span><span class=line><span class=cl>Bringing machine &#39;es3&#39; up with &#39;virtualbox&#39; provider...
</span></span><span class=line><span class=cl>==&gt; es1: Importing base box &#39;bento/centos-8&#39;...
</span></span><span class=line><span class=cl>==&gt; es1: Matching MAC address for NAT networking...
</span></span><span class=line><span class=cl>==&gt; es1: Checking if box &#39;bento/centos-8&#39; version &#39;202002.04.0&#39; is up to date...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>省略中间大量输出。。。。。。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    es3: ● elasticsearch.service - Elasticsearch
</span></span><span class=line><span class=cl>    es3:    Loaded: loaded (/usr/lib/systemd/system/elasticsearch.service; enabled; vendor preset: disabled)
</span></span><span class=line><span class=cl>    es3:    Active: active (running) since Thu 2020-08-27 05:55:21 UTC; 223ms ago
</span></span><span class=line><span class=cl>    es3:      Docs: https://www.elastic.co
</span></span><span class=line><span class=cl>    es3:  Main PID: 4205 (java)
</span></span><span class=line><span class=cl>    es3:     Tasks: 41 (limit: 11499)
</span></span><span class=line><span class=cl>    es3:    Memory: 1.2G
</span></span><span class=line><span class=cl>    es3:    CGroup: /system.slice/elasticsearch.service
</span></span><span class=line><span class=cl>    es3:            ├─4205 /usr/share/elasticsearch/jdk/bin/java -Xshare:auto -Des.networkaddress.cache.ttl=60 -Des.networkaddress.cache.negative.ttl=10 -XX:+AlwaysPreTouch -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -XX:-OmitStackTraceInFastThrow -XX:+ShowCodeDetailsInExceptionMessages -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dio.netty.allocator.numDirectArenas=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Djava.locale.providers=SPI,COMPAT -Xms1g -Xmx1g -XX:+UseG1GC -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -Djava.io.tmpdir=/tmp/elasticsearch-14730718416313121303 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/lib/elasticsearch -XX:ErrorFile=/var/log/elasticsearch/hs_err_pid%p.log -Xlog:gc*,gc+age=trace,safepoint:file=/var/log/elasticsearch/gc.log:utctime,pid,tags:filecount=32,filesize=64m -XX:MaxDirectMemorySize=536870912 -Des.path.home=/usr/share/elasticsearch -Des.path.conf=/etc/elasticsearch -Des.distribution.flavor=default -Des.distribution.type=rpm -Des.bundled_jdk=true -cp /usr/share/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch -p /var/run/elasticsearch/elasticsearch.pid --quiet
</span></span><span class=line><span class=cl>    es3:            └─4360 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller
</span></span><span class=line><span class=cl>    es3:
</span></span><span class=line><span class=cl>    es3: Aug 27 05:54:54 es3.zenlab.local systemd[1]: Starting Elasticsearch...
</span></span><span class=line><span class=cl>    es3: Aug 27 05:55:21 es3.zenlab.local systemd[1]: Started Elasticsearch.
</span></span><span class=line><span class=cl>    es3: Provisioning script works good!
</span></span><span class=line><span class=cl>    es3: Please access Elasticsearch https://192.168.50.13:9200
</span></span></code></pre></td></tr></table></div></div><p>最后的系统登录验证命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>➜  elasticstack git:(master) ✗ curl --cacert certs/ca/ca.crt -u elastic &#39;https://es1.zenlab.local:9200/_cat/nodes?v&#39;
</span></span><span class=line><span class=cl>Enter host password for user &#39;elastic&#39;:
</span></span><span class=line><span class=cl>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span></span><span class=line><span class=cl>192.168.50.13           26          95   8    0.03    0.31     0.18 dilmrt    -      es3
</span></span><span class=line><span class=cl>192.168.50.12           33          95   0    0.01    0.14     0.09 dilmrt    -      es2
</span></span><span class=line><span class=cl>192.168.50.11           36          93   1    0.06    0.16     0.12 dilmrt    *      es1
</span></span></code></pre></td></tr></table></div></div><p>以上命令需要输入 elastic 用户的密码，es1 节点初始化了所有 Elasticsearch 内置用户的密码，需要复制 console 中的那一段密码信息备用。</p><p>创建以上所有数字证书和秘钥文件的种子文件是 certs/instance.yml ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># instance.yml
</span></span><span class=line><span class=cl>instances:
</span></span><span class=line><span class=cl>  - name: &#39;es1&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.11&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es1.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#34;es2&#34;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.12&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es2.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;es3&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.13&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es3.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;es4&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.14&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es4.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#34;es5&#34;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.15&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es5.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;es6&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.16&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es6.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;es7&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.17&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es1.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#34;es8&#34;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.18&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es2.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;es9&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.19&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;es3.zenlab.local&#39; ]
</span></span><span class=line><span class=cl>  - name: &#39;lk&#39;
</span></span><span class=line><span class=cl>    ip: [&#39;192.168.50.20&#39;]
</span></span><span class=line><span class=cl>    dns: [ &#39;lk.zenlab.local&#39; ]
</span></span></code></pre></td></tr></table></div></div><p>这里一次性生产了所有我这个本地测试环境里可能用到的数字证书文件。</p><h2 id=elasticsearch-安装脚本>Elasticsearch 安装脚本</h2><p>下面是第一个 Elasticsearch 节点的安装脚本和注释，pre-install-es1.sh ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># author: Martin Liu</span>
</span></span><span class=line><span class=cl><span class=c1># url:martinliu.cn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#指定安装的版本</span>
</span></span><span class=line><span class=cl><span class=nv>elastic_version</span><span class=o>=</span><span class=s1>&#39;7.9.0&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#开始安装流程</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Provisioning a Elasticsearch &#34;</span><span class=nv>$elastic_version</span><span class=s2>&#34; Server...&#34;</span>
</span></span><span class=line><span class=cl>sudo date &gt; /etc/vagrant_provisioned_at
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#配置 ES 需要的操作系统参数</span>
</span></span><span class=line><span class=cl>sudo swapoff -a
</span></span><span class=line><span class=cl>sudo sysctl -w vm.max_map_count<span class=o>=</span><span class=m>262144</span>
</span></span><span class=line><span class=cl>sudo sysctl -p
</span></span><span class=line><span class=cl>sudo sh -c <span class=s2>&#34;echo &#39;elasticsearch  -  nofile  65535&#39; &gt;&gt; /etc/security/limits.conf&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#设置个性化 SSH 登录提示信息</span>
</span></span><span class=line><span class=cl>sudo sh -c <span class=s2>&#34;echo &#39;**** --  --  --  --  --  --  --  -- ****&#39; &gt; /etc/motd&#34;</span>
</span></span><span class=line><span class=cl>sudo sh -c <span class=s2>&#34;echo &#39;**** Welcome to Elastic Stack Labs&#39; &gt;&gt; /etc/motd&#34;</span>
</span></span><span class=line><span class=cl>sudo sh -c <span class=s2>&#34;echo &#39;**** --  --  --  --  --  --  --  -- ****&#39; &gt;&gt; /etc/motd&#34;</span>
</span></span><span class=line><span class=cl>sudo sh -c <span class=s2>&#34;echo &#39;*&#39; &gt;&gt; /etc/motd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#安装 ES 软件包</span>
</span></span><span class=line><span class=cl>sudo rpm -ivh /vagrant/rpm/elasticsearch-<span class=nv>$elastic_version</span>-x86_64.rpm 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#创建 ES 集群内部通信加密数字证书，提前清理旧的证书文件和目录</span>
</span></span><span class=line><span class=cl>sudo rm -f /vagrant/certs/certs.zip
</span></span><span class=line><span class=cl>sudo rm -rf /vagrant/certs/es*
</span></span><span class=line><span class=cl>sudo rm -rf /vagrant/certs/ca
</span></span><span class=line><span class=cl>sudo rm -rf /vagrant/certs/lk
</span></span><span class=line><span class=cl>sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert -in /vagrant/certs/instance.yml  -pem  -out /vagrant/certs/certs.zip -s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#解压缩所有证书备用</span>
</span></span><span class=line><span class=cl>sudo /usr/bin/unzip  /vagrant/certs/certs.zip -d /vagrant/certs/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#部署节点需要的秘钥</span>
</span></span><span class=line><span class=cl>sudo cp /vagrant/certs/ca/ca.crt  /etc/elasticsearch/
</span></span><span class=line><span class=cl>sudo cp /vagrant/certs/es1/* /etc/elasticsearch/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#更新 ES 默认的配置文件</span>
</span></span><span class=line><span class=cl>sudo cp /vagrant/es1.yml /etc/elasticsearch/elasticsearch.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#配置和启动 ES 系统服务</span>
</span></span><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> elasticsearch.service
</span></span><span class=line><span class=cl>sudo systemctl start elasticsearch.service
</span></span><span class=line><span class=cl>sudo systemctl status elasticsearch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#初始化 ES 服务器内建用户的密码，这些密码需要在控制台上复制保存备用</span>
</span></span><span class=line><span class=cl>sudo /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#成功顺利的完成了安装</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> Provisioning script works good!
</span></span><span class=line><span class=cl><span class=nb>echo</span> Please access Elasticsearch https://192.168.50.11:9200
</span></span></code></pre></td></tr></table></div></div><p>说明：你也可以参考以上脚本手工执行，如果是非 Vagrant 环境，请注意替换各个命令中相关文件的路径。第二个和第三个节点的安装脚本稍有不同，详情见代码库。</p><h2 id=elasticsearch-配置文件>Elasticsearch 配置文件</h2><p>下面是第一个 Elasticsearch 节点的参考配置文件， es1.yml ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># ---------------------------------- Cluster -----------------------------------
</span></span><span class=line><span class=cl>#设定集群名称
</span></span><span class=line><span class=cl>cluster.name: elk4devops
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ------------------------------------ Node ------------------------------------
</span></span><span class=line><span class=cl>#设定节点名称，此处使用的是 hostname
</span></span><span class=line><span class=cl>node.name: es1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ----------------------------------- Paths ------------------------------------
</span></span><span class=line><span class=cl>#设定 es 服务器数据目录
</span></span><span class=line><span class=cl>path.data: /var/lib/elasticsearch
</span></span><span class=line><span class=cl>#设定 es 服务器日志目录
</span></span><span class=line><span class=cl>path.logs: /var/log/elasticsearch
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ---------------------------------- Network -----------------------------------
</span></span><span class=line><span class=cl>#设定此节点加入网络的名称，这里使用的是 FQDN
</span></span><span class=line><span class=cl>network.host: es1.zenlab.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># --------------------------------- Discovery ----------------------------------
</span></span><span class=line><span class=cl>#设定初始的 master 节点为 es1
</span></span><span class=line><span class=cl>cluster.initial_master_nodes: [&#34;es1&#34;]
</span></span><span class=line><span class=cl>discovery.seed_hosts: [&#34;es1.zenlab.local&#34;]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ------------------------------- TLS and Cert ---------------------------------
</span></span><span class=line><span class=cl>#启用用户名和密码认证
</span></span><span class=line><span class=cl>xpack.security.enabled: true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#启用 ES 集群内加密传输
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.enabled: true
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.certificate_authorities: ca.crt
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.key: ${node.name}.key
</span></span><span class=line><span class=cl>xpack.security.transport.ssl.certificate: ${node.name}.crt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#启用 ES 集群客户端访问加密
</span></span><span class=line><span class=cl>xpack.security.http.ssl.enabled: true
</span></span><span class=line><span class=cl>xpack.security.http.ssl.certificate_authorities: ca.crt
</span></span><span class=line><span class=cl>xpack.security.http.ssl.key: ${node.name}.key
</span></span><span class=line><span class=cl>xpack.security.http.ssl.certificate: ${node.name}.crt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#  For Elastic Agent
</span></span><span class=line><span class=cl>xpack.security.authc.api_key.enabled: true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#启用监控数据收集
</span></span><span class=line><span class=cl>xpack.monitoring.collection.enabled: true
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#  ------------------------------- App Search ---------------------------------
</span></span><span class=line><span class=cl>#提前为 App Search 做好准备
</span></span><span class=line><span class=cl>action.auto_create_index: &#34;.app-search-*-logs-*,-.app-search-*,+*&#34;
</span></span></code></pre></td></tr></table></div></div><p>说明：第二个和第三个节点的配置文件稍有不同，详情见代码库。</p><h2 id=总结>总结</h2><p>在三节点集群的搭建过程中，最好建议启用各种安全和加密选项，用配置安装脚本最小化工作量；这样一步到位的安全性，可以为后续增加其他 Elastic Stack 的产品组件打下良好的基础，ES 集群的配置尽量完善，尽量覆盖后期的其他各种潜在需求，减少未来配置变更的工作量，让后续的测试越来越轻松。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/devops/>devops</a>
<a href=/tags/elastic-stack/>Elastic Stack</a>
<a href=/tags/elasticsearch/>elasticsearch</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>署名-非商业性使用-禁止演绎 3.0 未本地化版本 (CC BY-NC-ND 3.0)</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/elastic-agent-fleet-update-8-4/><div class=article-image><img src=/blog/elastic-agent-fleet-update-8-4/observability.a8ad1675299348b01e53a3be4a90ca09_hufdcbde205c36f9366f6d5cd3d02d46d5_27303_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Elastic Agent 和 Fleet 服务器 安装手册 v8.4" data-key=elastic-agent-fleet-update-8-4 data-hash="md5-qK0WdSmTSLAeU6O+SpDKCQ=="></div><div class=article-details><h2 class=article-title>Elastic Agent 和 Fleet 服务器 安装手册 v8.4</h2></div></a></article><article class=has-image><a href=/blog/fleet-and-elastic-agent/><div class=article-image><img src=/blog/fleet-and-elastic-agent/_hu3d03a01dcc18bc5be0e67db3d8d209a6_115239_0c2d44e6b0b9f731d4c3d973d28b4a8b.jpg width=250 height=150 loading=lazy alt="Featured image of post 面向未来的 Elastic Stack 数据摄入架构" data-key=fleet-and-Elastic-agent data-hash="md5-HMyU7kgaS/n8cDT9rwAs5A=="></div><div class=article-details><h2 class=article-title>面向未来的 Elastic Stack 数据摄入架构</h2></div></a></article><article class=has-image><a href=/blog/%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%8B%E9%83%A8%E7%BD%B2-elastic-stack-%E5%90%84%E7%A7%8D-beat-%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/><div class=article-image><img src=/images/abstract-6.jpg loading=lazy data-key data-hash=/images/abstract-6.jpg></div><div class=article-details><h2 class=article-title>腾讯云下部署 Elastic Stack 各种 Beat 的最佳实践</h2></div></a></article><article class=has-image><a href=/blog/apm-%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E4%B8%BA%E4%BD%95%E8%BF%99%E4%B9%88%E9%9A%BE/><div class=article-image><img src=/images/abstract-3.jpg loading=lazy data-key data-hash=/images/abstract-3.jpg></div><div class=article-details><h2 class=article-title>APM 分布式追踪为何这么难？</h2></div></a></article><article class=has-image><a href=/blog/%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91-dba-%E6%8A%80%E5%B7%A7%E9%9B%86%E9%94%A6/><div class=article-image><img src=/images/abstract-1.jpg loading=lazy data-key data-hash=/images/abstract-1.jpg></div><div class=article-details><h2 class=article-title>应用开发 DBA 技巧集锦</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//martinliu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2007 -
2023 Martin Liu's Blog</section><section class=powerby>本博客始于 2007 年<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
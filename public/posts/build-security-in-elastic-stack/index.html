<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Beats 摄入数据的最佳实践 - Martin Liu's Blog</title><meta property="og:title" content="Beats 摄入数据的最佳实践"><meta name=twitter:title content="Beats 摄入数据的最佳实践"><meta name=description content="使 Elastic Stack 安全、能适应和可扩展的实战配置"><meta property="og:description" content="使 Elastic Stack 安全、能适应和可扩展的实战配置"><meta name=twitter:description content="使 Elastic Stack 安全、能适应和可扩展的实战配置"><meta name=author content="刘征 Martin Liu"><link href=https://martinliu.cn/favicon.ico rel=icon type=image/x-icon><meta name=msvalidate.01 content="12F570013342D1F8B60A455D09221C1D"><meta name=yandex-verification content="7e9acc85531b0f35"><meta name=google-site-verification content="4oSwNTpy1vzip3_lt6XhkhMfImCD_DZlvL3K1k-M8qk"><meta name=baidu-site-verification content="Z7d1tYkxzQ"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-TL37V8G');</script><meta property="og:image" content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:image content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@martinliu"><meta name=twitter:creator content="@martinliu"><meta property="og:url" content="https://martinliu.cn/posts/build-security-in-elastic-stack/"><meta property="og:type" content="website"><meta property="og:site_name" content="Martin's Blog"><meta name=keywords content="Metricbeat ,Elastic Stack ,Filebeat"><meta name=generator content="Hugo 0.80.0"><link rel=canonical href=https://martinliu.cn/posts/build-security-in-elastic-stack/><link rel=alternate href=https://martinliu.cn/index.xml type=application/rss+xml title="Martin's Blog"><script src=https://res.cloudinary.com/martinliu/raw/upload/static/jquery-1.12.4.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://martinliu.cn/css/main.css><link rel=stylesheet href=https://martinliu.cn/css/search.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://martinliu.cn/css/prism.css><script data-ad-client=ca-pub-4545355461463255 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-749876-6','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>切换导航</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://martinliu.cn/>Martin's Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=首页 href=https://martinliu.cn/>首页</a></li><li><a title=标签 href=https://martinliu.cn/tags>标签</a></li><li><a title=关于 href=https://martinliu.cn/about>关于</a></li><li><a title=书籍 href=https://martinliu.cn/book>书籍</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Martin's Blog" href=https://martinliu.cn/><img class=avatar-img src=https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg alt="Martin's Blog"></a></div></div></div></nav><div id=header-big-imgs data-num-img=1 data-img-src-1=https://martinliu.cn/images/locked-up.jpg data-img-desc-1=DevOps></div><header class="header-section has-img"><div class="intro-header big-img"><div class=container><div class=row><div class="col-lg-12 col-md-12 col-md-offset-0"><div class=post-heading><h1>Beats 摄入数据的最佳实践</h1><hr class=small><span class=post-subheading>使 Elastic Stack 安全、能适应和可扩展的实战配置</span>
<span class=post-meta></span></div></div></div></div><span class=img-desc style=display:inline></span></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div><h5 id=wc>字数：4500 |大约阅读时间 9 分钟</h5><h5 id=tags>标签:
<a href=https://martinliu.cn//tags/elastic>Elastic</a> &nbsp;
<a href=https://martinliu.cn//tags/beats>Beats</a> &nbsp;</h5></div><article role=main class=blog-post><p>本文概要：配置 ES 3 节点全加密，Kibana 的 SSL 加密配置，Beats 的高可靠性加密传输，用 RBAC 怎样把权限控制到最小，在配置文件中消除明文密码，这些你都做到了么？如何保证安全、能适应和可扩展的配置 Elastic Stack 技术栈，让我们从 Bests 的角度开始讲解。</p><h2 id=前言>前言</h2><p>本文使用的软版本：</p><ul><li>Elastic Stack 7.8.0</li><li>macOS 10.15.5</li><li>Vagrant 2.2.9</li><li>VirtualBox 6.0</li><li>CentOS 8.0</li></ul><p>下面的配置和测试过程基于以下 Vagrantfile ，你可以在其它任何同等的环境中测试下面的所有配置。</p><pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

# Every Vagrant development environment requires a box. You can search for
# boxes at https://atlas.hashicorp.com/search.
BOX_IMAGE = &quot;bento/centos-8&quot;
ES_COUNT = 3
NODE_COUNT = 4


Vagrant.configure(&quot;2&quot;) do |config|

  #设置所有 guest 使用相同的静态 dns 解析 /etc/hosts
  config.vm.provision :hosts, :sync_hosts =&gt; true
  #用 vagrant 默认密钥对 ssh 登录
  config.ssh.insert_key = false
  
  # 用于部署 Elasticsearch 服务器的集群
  (1..ES_COUNT).each do |i|
    config.vm.define &quot;es#{i}&quot; do |es_config|
      es_config.vm.box = BOX_IMAGE
      es_config.vm.hostname = &quot;es#{i}.zenlab.local&quot;
      es_config.vm.network :private_network, ip: &quot;192.168.50.#{i + 10}&quot;
      es_config.vm.provision :hosts, :sync_hosts =&gt; true
      es_config.vm.provider :virtualbox do |vb|
        vb.memory = 2048
        vb.cpus = 1 
      end
      es_config.vm.provision :shell, path: 'pre-install-ES.sh'
    end
  end
  
  # 用于部署 Kibana、Logstash 、APM Server、Heatbeat 和 Packetbeat
  config.vm.define &quot;lk&quot; do |lk_config|
    lk_config.vm.box = BOX_IMAGE
    lk_config.vm.hostname = &quot;lk.zenlab.local&quot;
    lk_config.vm.network :private_network, ip: &quot;192.168.50.20&quot;
    lk_config.vm.network 'forwarded_port', guest: 5601, host: 5601
    lk_config.vm.provision :hosts, :sync_hosts =&gt; true
    lk_config.vm.provider :virtualbox do |vb|
      vb.memory = 1024
      vb.cpus = 1
    end
    #logstash_config.vm.provision :shell, path: 'pre-install-ES.sh'
  end

  # 两个被管理节点，用于部署监控应用和各种 Beats 代理
  (1..NODE_COUNT).each do |i|
    config.vm.define &quot;node#{i}&quot; do |node_config|
      node_config.vm.box = BOX_IMAGE
      node_config.vm.hostname = &quot;node#{i}.zenlab.local&quot;
      node_config.vm.network :private_network, ip: &quot;192.168.50.#{i + 20}&quot;
      node_config.vm.provider :virtualbox do |vb|
        vb.memory = 1024
        vb.cpus = 1
      end
      node_config.vm.provision :shell, path: 'pre-install-beats.sh'
    end
  end

# Install avahi on all machines  
  config.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
    sh -c &quot;echo 'Welcome to Elastic Stack!'&quot; 
  SHELL
end
</code></pre><p>注：下文中所有路径中的 <code>/vagrant/</code> 目录是本 vagrant 测试环境中，所有虚拟机的共享目录，是所有节点上配置文件的原路径。如果你使用的不是 vagrant 环境，你需要在下面的测试中适当的替换。</p><h2 id=三节点-elasticsearch-服务器集群>三节点 Elasticsearch 服务器集群</h2><p>在每个节点上使用下面的初始化脚本，部署 Elasticsearch 服务器。</p><p>使用<code>vagrant up es1 es2 es3</code>命令创建并启动 ES 服务器三个节点。</p><pre><code># pre-install-ES.sh

elastic_version='7.8.0'
echo &quot;Provisioning a Elasticsearch &quot;$elastic_version&quot; Server...&quot;

sudo date &gt; /etc/vagrant_provisioned_at
sudo swapoff -a
sudo sysctl -w vm.max_map_count=262144
sudo sysctl -p
sudo sh -c &quot;echo 'elasticsearch  -  nofile  65535' &gt;&gt; /etc/security/limits.conf&quot;
sudo sh -c &quot;echo '**** --  --  --  --  --  --  --  -- ****' &gt; /etc/motd&quot;
sudo sh -c &quot;echo '**** Welcome to Elastic Stack Labs' &gt;&gt; /etc/motd&quot;
sudo sh -c &quot;echo '**** --  --  --  --  --  --  --  -- ****' &gt;&gt; /etc/motd&quot;
sudo sh -c &quot;echo '*' &gt;&gt; /etc/motd&quot;
sudo rpm -ivh /vagrant/rpm/elasticsearch-$elastic_version-x86_64.rpm 

</code></pre><p>上面的脚本简单的初始化了几个操作系统参数，然后完成了 rpm 包的安装。非vagrant 环境的需要手工上传 rpm 安装文件，和运行以上的命令。</p><h3 id=配置首个-es-服务器节点>配置首个 ES 服务器节点</h3><p>登录 es1 节点<code>vagrant ssh es1</code> ；</p><p>创建用于节点间传输所需要的数字证书和秘钥文件，下面是所使用的种子文件。</p><pre><code># instance.yml
instances:
  - name: 'es1'
    ip: ['192.168.50.11']
    dns: [ 'es1.zenlab.local' ]
  - name: &quot;es2&quot;
    ip: ['192.168.50.12']
    dns: [ 'es2.zenlab.local' ]
  - name: 'es3'
    ip: ['192.168.50.13']
    dns: [ 'es3.zenlab.local' ]
  - name: 'lk'
    ip: ['192.168.50.20']
    dns: [ 'lk.zenlab.local' ]
</code></pre><p>用 <code>elasticsearch-certutil</code> 创建证书文件包。</p><pre><code>sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert --ca --pem --in /vagrant/certs/instance.yml  --out /vagrant/certs/certs.zip
</code></pre><p>将得到的 zip 文件解压缩在适当的目录里备用。</p><p>重要步骤：在 Elasticsearch 的配置文件目录中放置必要的数字证书文件。</p><pre><code>sudo mkdir /etc/elasticsearch/certs
sudo cp /vagrant/certs/ca/ca.crt  /etc/elasticsearch/certs
sudo cp /vagrant/certs/es1/* /etc/elasticsearch/certs
sudo ls /etc/elasticsearch/certs
</code></pre><p>在 certs 目录中有三个文件：</p><ol><li>ca.crt CA 根证书</li><li>es1.crt 服务器证书</li><li>es1.key 私钥文件</li></ol><p>CA 根证书是在所有节点上发起对 ES 服务的 HTTPS 服务所需要的客户端证书。 es1.crt 和 es1.key 这样的必要对需要在所有 ES 节点上部署，用于 ES 节点间的 transport 协议加密传输，每个 ES 节点都是用自己的密钥对文件。</p><p>在 ES1 的主配置文件中打开安全选项和其它必要配置，示例配置文件如下。</p><pre><code># elasticsearch.yml
# ---------------------------------- Cluster -----------------------------------
cluster.name: elk4devops

# ------------------------------------ Node ------------------------------------
node.name: es1

# ----------------------------------- Paths ------------------------------------
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

# ---------------------------------- Network -----------------------------------
network.host: es1.zenlab.local

# --------------------------------- Discovery ----------------------------------
cluster.initial_master_nodes: [&quot;es1&quot;]
discovery.seed_hosts: [ &quot;es1.zenlab.local&quot; ]

# ------------------------------- TLS and Cert ---------------------------------
xpack.security.enabled: true

#外部服务加密配置
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.key: certs/es1.key
xpack.security.http.ssl.certificate: certs/es1.crt
xpack.security.http.ssl.certificate_authorities: certs/ca.crt

#集群内通讯加密配置
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.key: certs/es1.key
xpack.security.transport.ssl.certificate: certs/es1.crt
xpack.security.transport.ssl.certificate_authorities: certs/ca.crt

xpack.monitoring.collection.enabled: true

#  ------------------------------- App Search ---------------------------------
action.auto_create_index: &quot;.app-search-*-logs-*,-.app-search-*,+*&quot;
</code></pre><p>使用以上配置文件覆盖Elasticsearch 默认的配置文件，首次启动第一个 ES 节点的服务。</p><pre><code>sudo cp /vagrant/elasticsearch.yml /etc/elasticsearch/elasticsearch.yml
sudo systemctl daemon-reload
sudo systemctl start elasticsearch
</code></pre><p>用下面的命令查看启动日志，直到 elasticsearch 服务正常启动。</p><pre><code>sudo tail -f /var/log/elasticsearch/elk4devops.log
</code></pre><p>用下面的命令初始化 Elasticsearch 系统内置账号为随机复杂密码。</p><pre><code>sudo /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -u &quot;https://es1.zenlab.local:9200&quot; -b


Changed password for user apm_system
PASSWORD apm_system = irpVThXpbFDrdq2rBQUC

Changed password for user kibana_system
PASSWORD kibana_system = CxGNlkqQMbcp6u6XuCbk

Changed password for user kibana
PASSWORD kibana = CxGNlkqQMbcp6u6XuCbk

Changed password for user logstash_system
PASSWORD logstash_system = EOUiCyQQ97IHwUJs8Eum

Changed password for user beats_system
PASSWORD beats_system = EF8OdPmcpy1bUCgFVQ90

Changed password for user remote_monitoring_user
PASSWORD remote_monitoring_user = 3ZRBVo5Omu33McoOKgwE

Changed password for user elastic
PASSWORD elastic = ZSzN2idoU6hFa4f0ulPP
</code></pre><p>将上面随机生成的密码保存在安全的地方备用，这些内置的超级用户权限大，一旦遗失了密码，可能会造成重大的数据泄露。</p><p>用上面创建的账户测试第一个 ES 节点是否可以通过 https 正常访问，这里也测试 ca 公钥的可用性。</p><pre><code>curl --cacert /vagrant/certs/ca/ca.crt -u elastic 'https://es1.zenlab.local:9200/_cat/nodes?v'

</code></pre><p>在 es1 服务器的命令行运行以上命令，输入 elastic 的密码。应该可以看到正常的输出。<code>/vagrant/certs/ca/ca.crt</code> 这个路径替换成你的环境中的相关 ca 证书文件路径。</p><h3 id=配置第二个和第三个-es-服务器节点>配置第二个和第三个 ES 服务器节点</h3><p>剩下的两个节点在加入集群之前都已经通过初始化脚本安装完了 rpm 安装包。剩下的就是逐个节点的部署之前生产的证书文件和修改后的 elasticsearc.yml 主配置文件。在本文档参考的环境中使用如下命令。</p><p>登录 es 2 <code>vagrant ssh es2</code></p><p>配置 es2 的证书和秘钥文件，下面的复制原路径需要替换成你所使用的实际路径。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo mkdir /etc/elasticsearch/certs
sudo cp /vagrant/certs/ca/ca.crt  /etc/elasticsearch/certs
sudo cp /vagrant/certs/es2/* /etc/elasticsearch/certs
sudo ls /etc/elasticsearch/certs
</code></pre></div><p>部署 es2 的配置文件，然后启动这个节点的 Elasticsearch 服务。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo cp /vagrant/elasticsearch2.yml /etc/elasticsearch/elasticsearch.yml
sudo systemctl daemon-reload
sudo systemctl start elasticsearch
</code></pre></div><p><code>elasticsearch2.yml</code> 文件的内容如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#75715e># ---------------------------------- Cluster -----------------------------------</span>
<span style=color:#f92672>cluster.name</span>: <span style=color:#ae81ff>elk4devops</span>

<span style=color:#75715e># ------------------------------------ Node ------------------------------------</span>
<span style=color:#f92672>node.name</span>: <span style=color:#ae81ff>es2</span>

<span style=color:#75715e># ----------------------------------- Paths ------------------------------------</span>
<span style=color:#f92672>path.data</span>: <span style=color:#ae81ff>/var/lib/elasticsearch</span>
<span style=color:#f92672>path.logs</span>: <span style=color:#ae81ff>/var/log/elasticsearch</span>

<span style=color:#75715e># ---------------------------------- Network -----------------------------------</span>
<span style=color:#f92672>network.host</span>: <span style=color:#ae81ff>es2.zenlab.local</span>

<span style=color:#75715e># --------------------------------- Discovery ----------------------------------</span>
<span style=color:#f92672>cluster.initial_master_nodes</span>: [<span style=color:#e6db74>&#34;es1&#34;</span>]
<span style=color:#f92672>discovery.seed_hosts</span>: [ <span style=color:#e6db74>&#34;es1.zenlab.local&#34;</span> ]

<span style=color:#75715e># ------------------------------- TLS and Cert ---------------------------------</span>
<span style=color:#f92672>xpack.security.enabled</span>: <span style=color:#66d9ef>true</span>

<span style=color:#f92672>xpack.security.http.ssl.enabled</span>: <span style=color:#66d9ef>true</span>
<span style=color:#f92672>xpack.security.http.ssl.key</span>: <span style=color:#ae81ff>certs/es2.key</span>
<span style=color:#f92672>xpack.security.http.ssl.certificate</span>: <span style=color:#ae81ff>certs/es2.crt</span>
<span style=color:#f92672>xpack.security.http.ssl.certificate_authorities</span>: <span style=color:#ae81ff>certs/ca.crt</span>

<span style=color:#f92672>xpack.security.transport.ssl.enabled</span>: <span style=color:#66d9ef>true</span>
<span style=color:#f92672>xpack.security.transport.ssl.key</span>: <span style=color:#ae81ff>certs/es2.key</span>
<span style=color:#f92672>xpack.security.transport.ssl.certificate</span>: <span style=color:#ae81ff>certs/es2.crt</span>
<span style=color:#f92672>xpack.security.transport.ssl.certificate_authorities</span>: <span style=color:#ae81ff>certs/ca.crt</span>

<span style=color:#f92672>xpack.monitoring.collection.enabled</span>: <span style=color:#66d9ef>true</span>

<span style=color:#75715e>#  ------------------------------- App Search ---------------------------------</span>
<span style=color:#f92672>action.auto_create_index</span>: <span style=color:#e6db74>&#34;.app-search-*-logs-*,-.app-search-*,+*&#34;</span>
</code></pre></div><p>在 es2 的命令用下面的命令查看是否该节点正常加入了集群。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl --cacert /vagrant/certs/ca/ca.crt -u elastic <span style=color:#e6db74>&#39;https://es1.zenlab.local:9200/_cat/nodes?v&#39;</span>
Enter host password <span style=color:#66d9ef>for</span> user <span style=color:#e6db74>&#39;elastic&#39;</span>:
ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
192.168.50.11           <span style=color:#ae81ff>37</span>          <span style=color:#ae81ff>94</span>   <span style=color:#ae81ff>0</span>    0.00    0.05     0.06 dilmrt    *      es1
192.168.50.12           <span style=color:#ae81ff>17</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>9</span>    0.49    0.20     0.07 dilmrt    -      es2
</code></pre></div><p>注意上面 ca.crt 文件的路径，要输入的是 elasstic 用户的密码。 正常情况下两个节点都会出现在结果清单中。</p><p>用相似的命令初始化和启动 es3 节点的服务。es3 的主配置文件样例如下。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># ---------------------------------- Cluster -----------------------------------</span>
cluster.name: elk4devops

<span style=color:#75715e># ------------------------------------ Node ------------------------------------</span>
node.name: es3

<span style=color:#75715e># ----------------------------------- Paths ------------------------------------</span>
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

<span style=color:#75715e># ---------------------------------- Network -----------------------------------</span>
network.host: es3.zenlab.local

<span style=color:#75715e># --------------------------------- Discovery ----------------------------------</span>
cluster.initial_master_nodes: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;es1&#34;</span><span style=color:#f92672>]</span>
discovery.seed_hosts: <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;es1.zenlab.local&#34;</span> <span style=color:#f92672>]</span>

<span style=color:#75715e># ------------------------------- TLS and Cert ---------------------------------</span>
xpack.security.enabled: true

xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.key: certs/es3.key
xpack.security.http.ssl.certificate: certs/es3.crt
xpack.security.http.ssl.certificate_authorities: certs/ca.crt

xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.key: certs/es3.key
xpack.security.transport.ssl.certificate: certs/es3.crt
xpack.security.transport.ssl.certificate_authorities: certs/ca.crt

xpack.monitoring.collection.enabled: true

<span style=color:#75715e>#  ------------------------------- App Search ---------------------------------</span>
action.auto_create_index: <span style=color:#e6db74>&#34;.app-search-*-logs-*,-.app-search-*,+*&#34;</span>

</code></pre></div><p>最终集群的测试状态如下：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>vagrant@es1 ~<span style=color:#f92672>]</span>$ curl --cacert /vagrant/certs/ca/ca.crt -u elastic <span style=color:#e6db74>&#39;https://es1.zenlab.local:9200/_cat/nodes?v&#39;</span>
Enter host password <span style=color:#66d9ef>for</span> user <span style=color:#e6db74>&#39;elastic&#39;</span>:
ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
192.168.50.11           <span style=color:#ae81ff>20</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>6</span>    0.18    0.09     0.03 dilmrt    *      es1
192.168.50.13           <span style=color:#ae81ff>50</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>2</span>    0.02    0.07     0.03 dilmrt    -      es3
192.168.50.12           <span style=color:#ae81ff>25</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>1</span>    0.00    0.02     0.00 dilmrt    -      es2
</code></pre></div><h2 id=配置-kibana-服务器>配置 Kibana 服务器</h2><p>服务是必要的的管理界面，是数据搜索、可视化的重要工具。在 Elasticsearch 服务打开了外部 https 加密访问的情况下，Kibana 服务器的安装和配置也需要做如下调整。</p><p>Kibana 的 rpm 安装这里省略。下面直接进入相关的主要配置步骤。</p><p>复制用于链接 ES 集群的证书</p><pre><code>sudo mkdir /etc/kibana/certs
sudo cp /vagrant/certs/ca/ca.crt  /etc/kibana/certs
sudo cp /vagrant/certs/lk/* /etc/kibana/certs
sudo ls /etc/kibana/certs
</code></pre><p>修改默认的 kibana.yml 配置文件，然后覆盖默认的配置文件后启动 kibana 服务。</p><pre><code>sudo cp /vagrant/kibna.yml /etc/kibana/kibana.yml
sudo cat /etc/kibana/kibana.yml
sudo systemctl start kibana
</code></pre><p>监控 kibana 的启动日志，直到它正常启动。</p><pre><code>sudo tail -f /var/log/messages
</code></pre><p>启动后，使用浏览器访问 <code>https://lk.zenlab.lcoal:5601</code> Kibana 服务，使用 elastic 用户的密码登录，确保 Kibana 正常启动。</p><h2 id=配置权限-beats-账号>配置权限 Beats 账号</h2><p>在使用 Beats 采集监控数据的时候，Beats 的配置文件中需要配置一个后台 Elasticsearch 服务访问账号，安全起见需求需要将这个账号配置为只写权限。配置步骤如下。</p><p>在 Kibana 的用户管理中创建名为 <code>beats-writer</code> 的角色，如下图所示。</p><p><img src=https://martinliu.cn/images/writer-role.jpeg alt></p><p>以上这个角色拥有 filebeat 和 Metricbeat 两个索引的访问权限，这里是为了评估用户角色管理的工作量，否则可以每个索引单独设置一套必要权限的角色和用户，从而实现更安全的防护。</p><p>然后创建名为 <code>beats-writer</code> 的用户，设置一个密码，将它赋予 <code>beats-writer</code> 的角色（上面创建的）。</p><p><img src=https://martinliu.cn/images/beats-writer-user.jpeg alt></p><p>这样它就可以用于所有 Beats 节点的配置了。</p><h2 id=初始化首个-beats-节点>初始化首个 Beats 节点</h2><p>在 vagrant 测试环境中启动第一个用于测试 Beats 的节点。</p><p><code>vagrant up node1</code></p><p>这里使用了初始脚本安装相关的 rpm 安装包。</p><pre><code>#!/bin/bash
# author: Martin Liu
# url:martinliu.cn
elastic_version='7.8.0'
echo &quot;Installing a Filebeat &quot;$elastic_version&quot; agent...&quot;

sudo rpm -ivh /vagrant/rpm/filebeat-$elastic_version-x86_64.rpm
sudo systemctl enable  filebeat.service
sudo rpm -ivh /vagrant/rpm/metricbeat-$elastic_version-x86_64.rpm
sudo systemctl enable  metricbeat.service
sudo rpm -ivh /vagrant/rpm/auditbeat-$elastic_version-x86_64.rpm
sudo systemctl enable  auditbeat.service
</code></pre><p>登录该节点进行 Beats 的初始化配置。目前 Elasticsearch 集群还是空白的，还没有初始化任何 Beats 相关的索引、可视化和仪表板。这个初始化工作是通过，每种 Beats 的 setup 命令完成的。这个 setup 命令只需要在一个节点上成功执行一次即可，其它节点的配置文件中，连 setup 命令相关的配置都不需要。</p><p>这里使用的 filebeat.yml 参考文件如下：</p><pre><code>#=========================== Filebeat inputs =============================
filebeat.inputs:
- type: log
  enabled: false
  paths:
    - /var/log/*.log

#============================= Filebeat modules ===============================
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 5s

#==================== Elasticsearch template setting ==========================
setup.template.settings:
  index.number_of_shards: 1
  index.codec: best_compression

#============================== Kibana =====================================
setup.kibana:
  host: &quot;https://lk.zenlab.local:5601&quot;  

#-------------------------- Elasticsearch output ------------------------------
output.elasticsearch:
  hosts: [&quot;es1.zenlab.local:9200&quot;]
  username: &quot;elastic&quot;
  password: &quot;1l1lqVMMWMbLI6DCH0dQ&quot;
  protocol: https

#================================ Processors =====================================
processors:
  - add_host_metadata: 
      netinfo.enabled: true
      cache.ttl: 5m
      geo:
        name: bj-dc-01
        location: 35.5528, 116.2360
        continent_name: Asia
        country_iso_code: CN
        region_name: Beijing
        region_iso_code: CN-BJ
        city_name: Beijing 
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~
</code></pre><p>目前的计划是配置 Beats 直接访问 Elasticsearch 后台服务，不通过 Logstash 中转。以后增加这个参考配置。</p><p>在执行 filebeat setup 命令之前，还需要在 Beats 节点上部署上面生成的 ca 公钥文件。参考命令如下。</p><pre><code>sudo update-ca-trust enable
sudo cp /vagrant/certs/ca/ca.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust extract
</code></pre><p>这里把 ca.crt 公钥文件部署到了 CentOS 操作系统的的可信 CA 发放机构的目录中，其它操作系统中的这个证书路径可能不同，需要做替换，包括以上的证书更新命令也可能需要调整。</p><p>经过以上的配置之后，用之前的 curl 命令测试一下是否这个证书生效了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>[</span>vagrant@es1 ~<span style=color:#f92672>]</span>$ curl -u elastic <span style=color:#e6db74>&#39;https://es1.zenlab.local:9200/_cat/nodes?v&#39;</span>
Enter host password <span style=color:#66d9ef>for</span> user <span style=color:#e6db74>&#39;elastic&#39;</span>:
ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
192.168.50.11           <span style=color:#ae81ff>20</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>6</span>    0.18    0.09     0.03 dilmrt    *      es1
192.168.50.13           <span style=color:#ae81ff>50</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>2</span>    0.02    0.07     0.03 dilmrt    -      es3
192.168.50.12           <span style=color:#ae81ff>25</span>          <span style=color:#ae81ff>96</span>   <span style=color:#ae81ff>1</span>    0.00    0.02     0.00 dilmrt    -      es2
</code></pre></div><p>这次在参数中故意省略了 ca 证书文件路径，如果 curl 可以正常访问，那么 Beats 程序也可以，而且不需要在 Beats 配置文件中生命公钥的路径，更有利于在以后切换到另外一套 CA 秘钥后，配置文件的更新工作。</p><p>这里省略 Beats 配置文件的展示，参考一下命令做初始化前的准备。</p><pre><code>sudo cp -f /vagrant/filebeat.yml /etc/filebeat/filebeat.yml
sudo cp -f /vagrant/metricbeat.yml /etc/metricbeat/metricbeat.yml
sudo filebeat modules enable system
</code></pre><p>为了测试的方便起见，在 filebeat.yml 和 metricbeat.yml 文件中使用了超级用户 elastic ，如果这个动作伴随着 Elastic Stack 的版本升级需要经常发生，此处需要配置一个 Beats setup 用的专用角色和账户，从而避免多次使用超级用户。</p><p>下面运行 setup 命令：</p><pre><code>filebeat setup
metricbeat setup
</code></pre><p>这两个命令正常运行后，在 Kibana 里会增加增加相关的索引、pipeline、可视化和仪表板等对象。</p><p>使用下面的命令测试 filebeat 和 metricbeat 是否能正常的采集数据并传输到后台。</p><pre><code>filebeat -e 
metricbeat -e 
</code></pre><p>如果报错的话，将 level 在配置文件中设置为 debug，方便调试。调试成功之后，应该在 Kibana 的界面中，可以看到 node1 节点，点击后能看到实时更新过来的日志和监控指标。</p><p><img src=https://martinliu.cn/images/metric-node1.jpeg alt></p><h2 id=在新的节点上部署-beats>在新的节点上部署 Beats</h2><p>在新的需要部署 Beats 的节点上，可以使用下面的脚本配置和部署。</p><p>add-agent.sh</p><pre><code>#!/bin/bash
# author: Martin Liu
# url:martinliu.cn

elastic_version='7.8.0'
b_user='beats-writer'
b_pwd='DevOps1234'

echo &quot;############## Installing a Beats &quot;$elastic_version&quot; agent...&quot;
sudo rpm -ivh /vagrant/rpm/filebeat-$elastic_version-x86_64.rpm
sudo systemctl enable  filebeat.service
sudo filebeat modules enable system
sudo rpm -ivh /vagrant/rpm/metricbeat-$elastic_version-x86_64.rpm
sudo systemctl enable  metricbeat.service

echo &quot;################### Setup Public CA...&quot;
sudo update-ca-trust enable
sudo cp /vagrant/certs/ca/ca.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust extract

echo &quot;################### Update Beats configuration files ...&quot;
sudo cp -f /vagrant/filebeat-v1.yml /etc/filebeat/filebeat.yml
sudo cp -f /vagrant/metricbeat-v1.yml /etc/metricbeat/metricbeat.yml

echo &quot;################### Setup Keystor for Beats ...&quot;
echo $b_user  | sudo filebeat keystore add BEATS_WRITER_USERNAME --stdin --force
echo $b_pwd   | sudo filebeat keystore add BEATS_WRITER_PW --stdin --force
echo $b_user  | sudo metricbeat keystore add BEATS_WRITER_USERNAME --stdin --force
echo $b_pwd   | sudo metricbeat keystore add BEATS_WRITER_PW --stdin --force

echo &quot;################### Start Beats services ...&quot;

sudo systemctl start  metricbeat.service
sudo systemctl start  filebeat.service
</code></pre><p>简单说明以上脚本的功能：</p><ul><li>用 rpm 安装包安装所需要的 Beats，filebeat 开启 system 模块。</li><li>在目标操作系统里部署必须的 ca 证书到默认路径中，并启用。从而省略在所有 beats 文件中生命公钥文件的路径。</li><li>覆盖更新默认的 Beats 配置文件。</li><li>创建并初始化 Beats 配置文件中所需要的 beats-writer 用户名和密码。从而消除消除所有明文密码。以上脚本只需要在节点上更新的时候才允许，允许后删除，从而不会留下任何明文密码和账户信息。Beats 的任何模块配置中，如果需要配置任何密码账户也需要如法炮制，从而保证基本的安全性。</li><li>启动 Beats 服务</li></ul><p>以上脚本所使用的配置文件文件如下。</p><p>filebeat-v1.yml</p><pre><code>filebeat.inputs:
- type: log
  enabled: false
  paths:
    - /var/log/*.log

#============================= Filebeat modules ===============================
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 60s

#-------------------------- Elasticsearch output ------------------------------
output.elasticsearch:
  hosts: [&quot;es1.zenlab.local:9200&quot;,&quot;es2.zenlab.local:9200&quot;,&quot;es3.zenlab.local:9200&quot;]
  password: ${BEATS_WRITER_PW}
  username: ${BEATS_WRITER_USERNAME}
  protocol: https

#================================ Processors =====================================
processors:
  - add_host_metadata: 
      netinfo.enabled: true
      cache.ttl: 5m
      geo:
        name: bj-dc-01
        location: 35.5528, 116.2360
        continent_name: Asia
        country_iso_code: CN
        region_name: Beijing
        region_iso_code: CN-BJ
        city_name: Beijing 
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~
  - add_fields:
      target: ''
      fields:
        service.name: 'Elastic Cloud'
        service.id: 'ec-ww'

#==================== Best Practice Configuration ==========================
setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
</code></pre><p>metricbeat.yml</p><pre><code># =========================== Modules configuration ============================
metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 120s

#-------------------------- Elasticsearch output ------------------------------
output.elasticsearch:
  hosts: [&quot;es1.zenlab.local:9200&quot;,&quot;es2.zenlab.local:9200&quot;,&quot;es3.zenlab.local:9200&quot;]
  password: ${BEATS_WRITER_PW}
  username: ${BEATS_WRITER_USERNAME}
  protocol: https

#================================ Processors =====================================
processors:
  - add_host_metadata: 
      netinfo.enabled: true
      cache.ttl: 5m
      geo:
        name: bj-dc-01
        location: 35.5528, 116.2360
        continent_name: Asia
        country_iso_code: CN
        region_name: Beijing
        region_iso_code: CN-BJ
        city_name: Beijing 
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~
  - add_fields:
      target: ''
      fields:
        service.name: 'Elastic Cloud'
        service.id: 'ec-ww'

#==================== Best Practice Configuration ==========================
setup.ilm.check_exists: false
logging.level: error
queue.spool: ~
</code></pre><p>解释一下相关的重要配置。</p><ul><li>netinfo.enabled: true 收集所有网卡的配置信息，覆盖多块网卡的情况</li><li>geo: 地理位置信息对以后基于位置的查询打下基础，这对于监控和信息安全都非常重要。为以后基于 host 的上下文关联打下基础，方便在 apm、log、metric、heartbeat 和机器学习的界面中相互跳转。</li><li>add_fields: 在 fields 下面维护 ECS 数据定义中的必要的有意义的数据，在网上查询 ECS 的数据定义，这些字段可以优化以后的搜索逻辑。</li><li>最后一段是其它必要的最佳实践设置</li><li>output.elasticsearch : 这里使用了三个 ES 节点的链接地址，这里应该使用至少 2 个 Elasticsearch 集群中的 ingest 节点。</li></ul><h2 id=总结>总结</h2><p>本文没有展开说明和配置的地方包括：对 Best 节点的工作状态的监控；对索引生命周期规则的调优（用尽磁盘），冷热数据的自动化迁移规则。</p><p>完成的配置包括：</p><ul><li>配置 ES 3 节点集群内部的 TLS 加密传输，对外的 HTTPS 加密协议服务</li><li>Kibana 基于证书的 SSL 加密配置</li><li>Beats 的高可靠性后台传输数据，TLS加密传输数据</li><li>用基于角色的访问控制，创建了只写权限的 beats-writer 角色和用户。</li><li>用 beats 的 keystore 将配置文件中的明文密码消除。</li></ul><a href=https://mp.weixin.qq.com/s/elRqbNlidJzmKCejBwtsAg target=_blank><img src=https://martinliu.cn/images/sref-zs.jpg alt="SRE Foundation 招生简章"></a></article><ul class="pager blog-pager"><li class=previous><a href=https://martinliu.cn/posts/a-comparison-of-devops-tools-p1/ data-toggle=tooltip data-placement=top title="徘徊在 3 种 DevOps 平台服务之间难以抉择（上）">&larr; 前一篇</a></li><li class=next><a href=https://martinliu.cn/posts/skaffold-make-local-k8s-dev-easy/ data-toggle=tooltip data-placement=top title="Skaffold 让 K8s 开发者更加酸爽">后一篇 &rarr;</a></li></ul><div></div></div></div></section></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:liuzh66@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/martinliu title=GitHub><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/martinliu title=GitLab><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/martinliu title=Twitter><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/liuzheng title=LinkedIn><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&copy;2017-2018
刘征 Martin Liu
&nbsp;&bull;&nbsp;
<a href=https://martinliu.cn/>Martin's Blog</a></p><p class="credits theme-by text-muted">由 <a href=http://gohugo.io>Hugo v0.80.0</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://res.cloudinary.com/martinliu/raw/upload/static/bootstrap.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe-ui-default.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/auto-render.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/main.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/prism.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/katex.min.js></script><script>renderMathInElement(document.body);</script></body></html>
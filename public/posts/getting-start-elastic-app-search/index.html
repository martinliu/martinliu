<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>随心所欲的为应用无痛添加搜索功能 - Martin Liu's Blog</title><meta property="og:title" content="随心所欲的为应用无痛添加搜索功能"><meta name=twitter:title content="随心所欲的为应用无痛添加搜索功能"><meta name=description content="开发搜索功能从此再也不用犯愁了，有了 App Search ，为应用增加搜索功能一下子变得简单了很多。本文描述了如何轻松上手这套搜索平台的所有步骤。 什么是 App Search? 这"><meta property="og:description" content="开发搜索功能从此再也不用犯愁了，有了 App Search ，为应用增加搜索功能一下子变得简单了很多。本文描述了如何轻松上手这套搜索平台的所有步骤。 什么是 App Search? 这"><meta name=twitter:description content="开发搜索功能从此再也不用犯愁了，有了 App Search ，为应用增加搜索功能一下子变得简单了很多。本文描述了如何轻松上手这套搜索平台的所有步骤。 什么是 App Search? 这"><meta name=author content="刘征 Martin Liu"><link href=https://martinliu.cn/favicon.ico rel=icon type=image/x-icon><meta name=msvalidate.01 content="12F570013342D1F8B60A455D09221C1D"><meta name=yandex-verification content="7e9acc85531b0f35"><meta name=google-site-verification content="4oSwNTpy1vzip3_lt6XhkhMfImCD_DZlvL3K1k-M8qk"><meta name=baidu-site-verification content="Z7d1tYkxzQ"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-TL37V8G');</script><meta property="og:image" content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:image content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@martinliu"><meta name=twitter:creator content="@martinliu"><meta property="og:url" content="https://martinliu.cn/posts/getting-start-elastic-app-search/"><meta property="og:type" content="website"><meta property="og:site_name" content="Martin's Blog"><meta name=keywords content="DevOps ,elastic stack ,app-search"><meta name=generator content="Hugo 0.80.0"><link rel=canonical href=https://martinliu.cn/posts/getting-start-elastic-app-search/><link rel=alternate href=https://martinliu.cn/index.xml type=application/rss+xml title="Martin's Blog"><script src=https://res.cloudinary.com/martinliu/raw/upload/static/jquery-1.12.4.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://martinliu.cn/css/main.css><link rel=stylesheet href=https://martinliu.cn/css/search.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://martinliu.cn/css/prism.css><script data-ad-client=ca-pub-4545355461463255 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-749876-6','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>切换导航</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://martinliu.cn/>Martin's Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=首页 href=https://martinliu.cn/>首页</a></li><li><a title=标签 href=https://martinliu.cn/tags>标签</a></li><li><a title=关于 href=https://martinliu.cn/about>关于</a></li><li><a title=书籍 href=https://martinliu.cn/book>书籍</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Martin's Blog" href=https://martinliu.cn/><img class=avatar-img src=https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg alt="Martin's Blog"></a></div></div></div></nav><div id=header-big-imgs data-num-img=1 data-img-src-1=https://res.cloudinary.com/martinliu/image/upload/abstract-1.jpg data-img-desc-1=DevOps></div><header class="header-section has-img"><div class="intro-header big-img"><div class=container><div class=row><div class="col-lg-12 col-md-12 col-md-offset-0"><div class=post-heading><h1>随心所欲的为应用无痛添加搜索功能</h1><span class=post-meta></span></div></div></div></div><span class=img-desc style=display:inline></span></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div><h5 id=wc>字数：2100 |大约阅读时间 5 分钟</h5><h5 id=tags>标签:
<a href=https://martinliu.cn//tags/elk>elk</a> &nbsp;</h5></div><article role=main class=blog-post><p>开发搜索功能从此再也不用犯愁了，有了 App Search ，为应用增加搜索功能一下子变得简单了很多。本文描述了如何轻松上手这套搜索平台的所有步骤。</p><p>什么是 App Search? 这是一套强大的 API 和开发者工具集，以构建功能强大的面向用户的搜索应用为目标。相关详细介绍见 <a href=https://www.elastic.co/cn/app-search>https://www.elastic.co/cn/app-search</a></p><p><img src=https://martinliu.cn/images/apps1.jpg alt></p><p>丰富的开箱即用功能:</p><ul><li>为相关性搜索应用场景而优化</li><li>拼写错误容忍</li><li>相关度调整</li><li>支持第三方 API 客户端，且具备强大的 API</li><li>独立的 API 日志和搜索分析</li><li>自动化扩展&运维支持</li><li>Search UI library</li></ul><h2 id=环境准备>环境准备</h2><p>测试环境现需要一台 Elasticsearch 服务器，或者和下面等同的环境。</p><p>本文的环境描述如下：</p><ul><li>macOS 10.15.4</li><li>vagrant 2.2.7</li><li>virtualbox 6.0.15</li><li>虚拟机模板 bento/centos-8</li><li>elasticsearch 7.6.1</li><li>app-search 7.6.1</li><li>jdk-11.06</li></ul><p>本文的测试环境基于 Vagrant + VirtualBox 的组合环境搭建而成，基础安装工作可以一键完成。</p><p>主要脚本 Vagrantfile、pre-install-ES.sh 请参考此代码库：</p><p><a href=https://github.com/martinliu/elastic-labs/tree/master/app-search>https://github.com/martinliu/elastic-labs/tree/master/app-search</a></p><p>开启并登陆这套安装环境的命令如下。</p><pre><code>vagrant up
vagrant ssh
</code></pre><p>在以上命令的启动信息里找到如下的 elastic 用户密码部分备用。</p><pre><code>master1: Changed password for user elastic
master1: PASSWORD elastic = eczHJ7NPrsO1B1BRA8SS
</code></pre><h2 id=安装-app-search>安装 App Search</h2><p>浏览 App Search 的安装文档： <a href=https://swiftype.com/documentation/app-search/self-managed/installation>https://swiftype.com/documentation/app-search/self-managed/installation</a></p><p>安装 App Search 所需的 JDK 8 或者 11 ，本文安装的是 Oracle 的 JDK 11。本文假设所有的安装文件和已经编辑好的配置文件都放在了 /vagrant 目录下。</p><p><code>sudo rpm -ivh /vagrant/rpm/jdk-11.0.6_linux-x64_bin.rpm</code></p><p>安装 App Search 服务器。</p><p><code>sudo rpm -ivh /vagrant/rpm/app-search-7.6.1.rpm</code></p><p>浏览 App Search 服务器默认的配置文件，了解有哪些可用选项。</p><p><code>sudo more /usr/share/app-search/config/app-search.yml</code></p><p>将 Elasticsearch 服务器安装时产生的随机密码更新到 app-search.yml 文件中，并且定制它的内容如下：</p><pre><code>allow_es_settings_modification: true
elasticsearch.host: http://192.168.50.10:9200
elasticsearch.username: elastic
elasticsearch.password: eczHJ7NPrsO1B1BRA8SS
app_search.external_url: http://192.168.50.10:3002
app_search.listen_host: 192.168.50.10
app_search.listen_port: 3002
log_directory: /var/log/app-search
filebeat_log_directory: /var/log/app-search
</code></pre><p>将更新好的 app-search.yml 更新到它默认的路径中。</p><p><code>sudo cp /vagrant/appsearch/app-search.yml /usr/share/app-search/config/app-search.yml</code></p><p>启动 App Search 服务器。</p><p><code>sudo /usr/share/app-search/bin/app-search</code></p><p>在启动日志中，找到如下的默认用户名和密码。</p><pre><code>#########################################################

*** Default user credentials have been setup. These are only printed once, so please ensure they are recorded. ***
      username: app_search
      password: vjqmjhv2s5rzixjc

#########################################################

</code></pre><p>在服务器初始化启动完毕之后，用上面的用户名和密码，在浏览器中登录 App Search 服务器 http://192.168.50.10:3002</p><p>到此为止，App Search 服务器的安装就完成了。它其实是一个基于 Elasticsearch 的搜索服务平台。</p><p>它的特点是帮助开发者随心所欲的为已有的或者正在开发的项目增加功能强大的搜索功能，而且将搜索功能的实施成本降低到无痛点的程度。App Search 可以覆盖的使用场景如下：</p><ul><li>SaaS / web 应用</li><li>复杂的电商应用</li><li>客户支持服务站点</li><li>Geo 地理搜索</li><li>公司官网</li><li>内部的搜索</li><li>还有更多其他</li></ul><h2 id=创建名为-games-的搜索引擎>创建名为 games 的搜索引擎</h2><p>在首页的创建引擎的输入框中输入 games， 语言选择默认选项，点击创建。浏览新创建的引擎，点击左下角的菜单 Credentials，复制 privite-key 备用。</p><p><img src=https://martinliu.cn/images/apps2.jpg alt></p><p>找到这个搜索引擎的 API 调用网址备用。
<code>http://192.168.50.10:3002/api/as/v1/</code></p><p><img src=https://martinliu.cn/images/apps3.jpg alt></p><h2 id=通过-api-索引数据文档>通过 API 索引数据文档</h2><p>需要通过 App Search 提供的 API 索引一份具有 4000+ 条数据的 json 文件。数据文件见代码库中的 <code>video-games.json</code> 。本文使用 Ruby 编写了一个上传脚本，见 <code>upload.rb</code> ，该脚本使用了名为 elastic-app-search 的客户端库。你可以使用其他编程语音，实现待接入系统和 App Search 服务器的对接，并与之保持同步，保持待搜索数据的更新。</p><pre><code># `gem install elastic-app-search progress_bar`

require 'elastic-app-search'
require 'json'
require 'progress_bar'

API_ENDPOINT = 'http://192.168.50.10:3002/api/as//v1/'
API_KEY = 'private-jdhcmi1yhy8wjxo6upb4qki3'
ENGINE_NAME = 'games'

client = Elastic::AppSearch::Client.new(:api_key =&gt; API_KEY, :api_endpoint =&gt; API_ENDPOINT)
file = File.read('./video-games.json')
data = JSON.parse(file)
bar = ProgressBar.new(data.count / 100)

data.each_slice(100) do |slice|
  client.index_documents(ENGINE_NAME, slice)
  bar.increment!
end

</code></pre><p>以上脚本中的 API_ENDPOINT 和 API_KEY 需要更新，与当前测试系统匹配。这个脚本的运行效果如下：</p><pre><code>➜  app-search git:(master) ✗ ruby upload.rb
[##########################################################################] [40/40] [100.00%] [00:54] [00:00] [ 0.73/s]

</code></pre><p>索引之后，在搜引擎的 Documents 页面，浏览索引后的数据，用 Query Tester 进行一些搜索，了解这些数据的内容，注意观察当前搜索的结果和排序。</p><h2 id=修订-schema>修订 Schema</h2><p>开发者可以按照需要随时修改 Schema，实际上这是一个 Schema 的平台。 Schema 的修改后，数据即可生效，在这个过程中前端用户的搜索体验不会受到任何影响。</p><p><img src=https://martinliu.cn/images/apps4.jpg alt></p><p>修改三个字段的定义，并增加 language 字段，点击右上角的 Update Type 按钮生效。</p><h2 id=按需进行搜索设置>按需进行搜索设置</h2><h3 id=创建同义词>创建同义词</h3><p>为 Pokemon 创建同义词 Pikachu，如下图所示。</p><p><img src=https://martinliu.cn/images/apps5.jpg alt></p><h3 id=调整搜索字段的权重>调整搜索字段的权重</h3><p>为 globa_sales 增加 Functional Boost 1。
<img src=https://martinliu.cn/images/apps6.jpg alt></p><p>为 Name 增加 weight 3 ，点击右上角的 Save 保存。在这个过程中观察右侧的搜结果的动态变化，还可以做其他字段的修改，知道搜素结果满意为止。</p><p><img src=https://martinliu.cn/images/apps7.jpg alt></p><h3 id=创建-curations>创建 curations</h3><p>故意将某条搜索结果置顶，这有可能因为，这款游戏目前是热评游戏，是畅销爆款，是高利率商品，是广告商品，或者其他业务原因。可以给某个关键字，置顶一条或者多条搜索结果。下面将 pokemon 的 pokemon-ranger-ds-2006 这款产品置顶。点击右上角的 Query Tester 测试一下效果。</p><p><img src=https://martinliu.cn/images/apps8.jpg alt></p><h2 id=创建用户端搜索界面>创建用户端搜索界面</h2><p>Reference UI 是提供给用户使用的搜索界面，它可以是只有一个输入框，也可以是比较复杂的条件查询。如下所示。</p><p><img src=https://martinliu.cn/images/apps10.jpg alt></p><p>调整之后点击 Create Preview 按钮，进入搜素界面的确认页面，尝试使用所设定的搜索功能。满意后点击右上角的 Download ZIP Package 按钮下载这个界面的所有代码。</p><p><img src=https://martinliu.cn/images/apps11.jpg alt></p><p>在本地解压缩这份搜索代码，并进行调试。</p><p>在命令行，进入这个目录，先执行 <code>npm install </code>命令，然后执行<code>npm start</code>命令。</p><pre><code>Compiled successfully!

You can now view app-search-reference-ui-react in the browser.

  Local:            http://localhost:3000/
  On Your Network:  http://192.168.1.6:3000/

Note that the development build is not optimized.
To create a production build, use npm run build.
</code></pre><p>在弹出的网页中，在本地测试这个搜索界面的可用性。最后运行 <code>npm run build</code> 命令，</p><pre><code>➜  games-react-demo-ui git:(master) ✗ npm run build

&gt; app-search-reference-ui-react@1.2.0 build /Users/martin/code/elastic-labs/app-search/games-react-demo-ui
&gt; npm-run-all build-css build-js


&gt; app-search-reference-ui-react@1.2.0 build-css /Users/martin/code/elastic-labs/app-search/games-react-demo-ui
&gt; node-sass-chokidar src/ -o src/

No input files were found.

&gt; app-search-reference-ui-react@1.2.0 build-js /Users/martin/code/elastic-labs/app-search/games-react-demo-ui
&gt; node ./scripts/build-no-chunks.js

Creating an optimized production build...
Browserslist: caniuse-lite is outdated. Please run next command `npm update`
Browserslist: caniuse-lite is outdated. Please run next command `npm update`
Compiled successfully.

File sizes after gzip:

  109.1 KB  build/static/js/main.2f745bc0.js
  3.64 KB   build/static/css/main.e43852a4.css

The project was built assuming it is hosted at the server root.
You can control this with the homepage field in your package.json.
For example, add this to build it for GitHub Pages:

  &quot;homepage&quot; : &quot;http://myname.github.io/myapp&quot;,

The build folder is ready to be deployed.
You may serve it with a static server:

  npm install -g serve
  serve -s build

Find out more about deployment here:

  https://bit.ly/CRA-deploy

</code></pre><p>最后将构建结果部署到一个目标的先安装的 Nginx 服务器上。</p><pre><code>sudo yum install -y nginx
sudo mv -f build/* /usr/share/nginx/html
</code></pre><p>在浏览器中访问 Nginx 服务器 <code>http://192.168.50.10/index.html</code> 观察最终的实现效果。
<img src=https://martinliu.cn/images/apps12.jpg alt></p><h2 id=总结>总结</h2><p>使用 App Search 搜索平台，开发者可以快速的开发出一套定制化的搜索系统，轻松的实现后台搜索业务逻辑的调整，并轻松的将用户搜索界面测试后部署上线。</p><a href=https://mp.weixin.qq.com/s/elRqbNlidJzmKCejBwtsAg target=_blank><img src=https://martinliu.cn/images/sref-zs.jpg alt="SRE Foundation 招生简章"></a></article><ul class="pager blog-pager"><li class=previous><a href=https://martinliu.cn/posts/using-elastic-stack-for-monitoring-covid-19/ data-toggle=tooltip data-placement=top title="使用 Elastic Stack 监控 Covid-19 疫情发展">&larr; 前一篇</a></li><li class=next><a href=https://martinliu.cn/posts/getting-start-elastic-workplace-search/ data-toggle=tooltip data-placement=top title="入门 Elastic Workplace Search">后一篇 &rarr;</a></li></ul><div><h2>See Also</h2><ul><li><a href=https://martinliu.cn/posts/using-elastic-stack-for-monitoring-covid-19/>使用 Elastic Stack 监控 Covid-19 疫情发展</a></li><li><a href=https://martinliu.cn/posts/download-import-vagrant-box/>如何在墙内正常导入 Vagrant 虚拟机模板</a></li><li><a href=https://martinliu.cn/posts/sre-sla-slo-sli/>SLA、SLO 和 SLI 还是傻傻分不清么？</a></li><li><a href=https://martinliu.cn/book/>出版书籍</a></li><li><a href=https://martinliu.cn/posts/2019-state-devops-report-insight-2/>怎样使用两个DevOps研究模型？</a></li></ul></div></div></div></section></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:liuzh66@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/martinliu title=GitHub><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/martinliu title=GitLab><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/martinliu title=Twitter><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/liuzheng title=LinkedIn><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&copy;2017-2018
刘征 Martin Liu
&nbsp;&bull;&nbsp;
<a href=https://martinliu.cn/>Martin's Blog</a></p><p class="credits theme-by text-muted">由 <a href=http://gohugo.io>Hugo v0.80.0</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://res.cloudinary.com/martinliu/raw/upload/static/bootstrap.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe-ui-default.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/auto-render.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/main.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/prism.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/katex.min.js></script><script>renderMathInElement(document.body);</script></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Skaffold 让 K8s 开发者更加酸爽 - Martin Liu's Blog</title><meta property="og:title" content="Skaffold 让 K8s 开发者更加酸爽"><meta name=twitter:title content="Skaffold 让 K8s 开发者更加酸爽"><meta name=description content="Skaffold是本地 Kubernetes 开发者的又一个利器"><meta property="og:description" content="Skaffold是本地 Kubernetes 开发者的又一个利器"><meta name=twitter:description content="Skaffold是本地 Kubernetes 开发者的又一个利器"><meta name=author content="刘征 Martin Liu"><link href=https://martinliu.cn/favicon.ico rel=icon type=image/x-icon><meta name=msvalidate.01 content="12F570013342D1F8B60A455D09221C1D"><meta name=yandex-verification content="7e9acc85531b0f35"><meta name=google-site-verification content="4oSwNTpy1vzip3_lt6XhkhMfImCD_DZlvL3K1k-M8qk"><meta name=baidu-site-verification content="Z7d1tYkxzQ"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-TL37V8G');</script><meta property="og:image" content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:image content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@martinliu"><meta name=twitter:creator content="@martinliu"><meta property="og:url" content="https://martinliu.cn/posts/skaffold-make-local-k8s-dev-easy/"><meta property="og:type" content="website"><meta property="og:site_name" content="Martin's Blog"><meta name=keywords content="DevOps ,Kubernetes ,CI ,CD ,Skaffold"><meta name=generator content="Hugo 0.80.0"><link rel=canonical href=https://martinliu.cn/posts/skaffold-make-local-k8s-dev-easy/><link rel=alternate href=https://martinliu.cn/index.xml type=application/rss+xml title="Martin's Blog"><script src=https://res.cloudinary.com/martinliu/raw/upload/static/jquery-1.12.4.min.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css integrity=sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0 crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://martinliu.cn/css/main.css><link rel=stylesheet href=https://martinliu.cn/css/search.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://martinliu.cn/css/prism.css><script data-ad-client=ca-pub-4545355461463255 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-749876-6','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>切换导航</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://martinliu.cn/>Martin's Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=首页 href=https://martinliu.cn/>首页</a></li><li><a title=标签 href=https://martinliu.cn/tags>标签</a></li><li><a title=关于 href=https://martinliu.cn/about>关于</a></li><li><a title=书籍 href=https://martinliu.cn/book>书籍</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Martin's Blog" href=https://martinliu.cn/><img class=avatar-img src=https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg alt="Martin's Blog"></a></div></div></div></nav><div id=header-big-imgs data-num-img=1 data-img-src-1=https://res.cloudinary.com/martinliu/image/upload/abstract-1.jpg data-img-desc-1=DevOps></div><header class="header-section has-img"><div class="intro-header big-img"><div class=container><div class=row><div class="col-lg-12 col-md-12 col-md-offset-0"><div class=post-heading><h1>Skaffold 让 K8s 开发者更加酸爽</h1><hr class=small><span class=post-subheading>Skaffold是本地 Kubernetes 开发者的又一个利器</span>
<span class=post-meta></span></div></div></div></div><span class=img-desc style=display:inline></span></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div><h5 id=wc>字数：2100 |大约阅读时间 5 分钟</h5><h5 id=tags>标签:
<a href=https://martinliu.cn//tags/devops>DevOps</a> &nbsp;
<a href=https://martinliu.cn//tags/kubernetes>Kubernetes</a> &nbsp;
<a href=https://martinliu.cn//tags/ci>CI</a> &nbsp;</h5></div><article role=main class=blog-post><p><img src=https://martinliu.cn/images/skaffold.png alt></p><p>今天介绍一个本地 Kubernetes 开发的利器 Skaffold。
这是我偶然间发现的一个工具，询问了一下周围的人，居然还没有人用过。测试之后，确实有一种不吐不快的感觉。</p><h2 id=简介>简介</h2><p><img src=https://martinliu.cn/images/intro.gif alt></p><p>Skaffold Google 开发的一个开源项目。是一个非常轻量的命令行工具，就是一个可执行文件。它的主页上是这样的介绍它的。</p><ul><li>轻量：Skaffold只是一个客户端工具。由于集群上不需要任何的相关组件，您的集群没有任何开销或维护负担。</li><li>运行在任何地方：Skaffold是与世界分享你的项目的最简单的方法：&ldquo;git clone&rdquo;，然后 &ldquo;skaffold run&rdquo;。此外，你还可以使用配置文件、本地用户配置、环境变量和标志来轻松地集成不同环境的差异。</li><li>功能丰富：Skaffold拥有许多Kubernetes原生开发的基本功能，包括基于策略的打镜像标签、资源端口转发和日志、文件同步等。</li><li>优化你的开发：Skaffold使内部循环紧密，高度优化，让您在开发的同时得到即时反馈。</li></ul><h2 id=客户评价>客户评价</h2><p><img src=https://martinliu.cn/images/forgerock.png alt></p><p>&ldquo;我们的客户很喜欢[Kubernetes]，但一直给我们反馈说在Kubernetes上开发很麻烦。Skaffold一针见血地解决了这个问题。以前需要几分钟才能部署的docker镜像或配置的更改，现在只需要几秒钟。Skaffold的插件架构使我们能够部署到Helm或Kustomize，并使用各种docker构建插件，如Kaniko。Skaffold用一个精简的工具取代了我们定制的实用程序和脚本集合，并且易于使用。&rdquo;
Warren Strange，ForgeRock的工程总监。</p><p><img src=https://martinliu.cn/images/quora.png alt></p><p>&ldquo;当我们评估我们可以使用Kubernetes的工作流程时，Skaffold脱颖而出，成为我们在开发和部署中都想要的工具。它为我们提供了一个跨应用程序的通用入口点，我们也可以为CI/CD重用。现在，我们所有的Kubernetes应用的CI/CD管道在构建和部署时都使用Skaffold。&rdquo;
Taylor Barrella，Quora的软件工程师</p><p><img src=https://martinliu.cn/images/tng.png alt></p><p>&ldquo;Skaffold是一个了不起的工具，它为我们简化了开发和交付。Skaffold通过覆盖两个维度，击中了我们的甜蜜点。第一，从本地开发、集成测试到交付的整个开发周期。第二，Skaffold让我们能够在Linux、OSX和Windows上独立开发，不需要特定的平台逻辑。&rdquo;
Martin Höfling，TNG技术咨询有限公司首席顾问</p><h2 id=推荐首次测试流程>推荐首次测试流程</h2><p>前置条件，你的开发用工作电脑上已经安装了它需要调用的 kubectl 和 docker 命令，kubectl 需要有至少一个可用的配置，这个配置可以指向任一一个你有权限部署的 Kubernetes 集群。</p><p>我在 macOS 上，直接运行 <code>‌brew install skaffold</code> 即可，其它系统参考：https://skaffold.dev/docs/install/</p><p>克隆 Skaffold 的代码库到本地，获取必要的测试应用代码。</p><p><code>‌git clone https://github.com/GoogleContainerTools/skaffold</code></p><p>进入代码库中的‘hello world’示例应用。</p><p>执行：<code>‌cd skaffold/examples/getting-started</code></p><p>执行 <code>‌skaffold dev</code> ，你会看到 Skaffold 进入了这个项目的构建和运行的状态，执行结果是持续的输出 ”[getting-started] Hello world!“</p><p>现在 Skaffold 就进入了 /getting-started 的监视状态。观察任何代码文件的修改存盘动作，每次代码的变更会触发 Skaffold 流水线的执行，skaffold.yaml 文件中描述了本地流水线中的相关动作：</p><ul><li>使用 Dockerfile 从源头构建Docker镜像。</li><li>用Docker镜像的内容的sha256哈希值来打上标签。</li><li>更新 Kubernetes manifest k8s-pod.yaml，以使用上一步构建的镜像。</li><li>使用 kubectl apply -f 部署 Kubernetes manifest。</li><li>从已部署的应用程序取回日志在本地控制台显示。</li></ul><p>现在用代码编辑器打开这个项目唯一的程序文件 main.go ，修改其中的 Hello World 为其它你想到的词，保存后，观察构建的过程。</p><h2 id=推荐微服务测试>推荐微服务测试</h2><p>参考以下视频，测试 Skaffold 代码库中的 microservice 项目。</p><h2 id=skaffold-流水线阶段>Skaffold 流水线阶段</h2><p>Skaffold 主要会用到五个阶段。</p><p><img src=https://martinliu.cn/images/workflow.png alt></p><p>其所有阶段如下：</p><ul><li>Init ： generate a starting point for Skaffold configuration</li><li>Build ：build images with different builders</li><li>Tag ： tag images based on different policies</li><li>Test ：test images with structure tests</li><li>Deploy ：deploy with kubectl, kustomize or helm</li><li>File Sync ： sync changed files directly to containers</li><li>Log ： Tailing tail logs from workloads</li><li>Port Forwarding ：forward ports from services and arbitrary resources to localhost</li><li>Cleanup ： cleanup manifests and images</li></ul><p>当你启动Skaffold时，它就会收集你项目中的源代码，并使用你所选择的工具构建工件；工件一旦成功构建，就会根据你的需要进行标记，并推送到你指定的仓库中。在工作流程的最后，Skaffold还帮助你将工件部署到你的Kubernetes集群中，同样使用你喜欢的工具。</p><p>Skaffold允许你跳过各个阶段。例如，如果你在本地使用Minikube运行Kubernetes，Skaffold不会将工件推送到远程仓库。</p><p>每个阶段的详情见：https://skaffold.dev/docs/pipeline-stages/</p><h2 id=架构设计>架构设计</h2><p>Skaffold 秉承着插件化的设计思想。</p><p><img src=https://martinliu.cn/images/architecture.png alt></p><p>以上架构内置了对下来工具的支持：</p><ul><li>Build<ul><li>Dockerfile locally, in-cluster with kaniko or on cloud using Google Cloud Build</li><li>Jib Maven and Jib Gradle locally or on cloud using Google Cloud Build</li><li>Bazel locally</li><li>Cloud Native Buildpacks locally or on cloud using Google Cloud Build</li><li>Custom script locally or in-cluster</li></ul></li><li>Test<ul><li>container-structure-test</li></ul></li><li>Tag</li></ul><ul><li>Git tagger</li><li>Sha256 tagger</li><li>Env Template tagger</li><li>DateTime tagger</li></ul><ul><li>Deploy</li></ul><ul><li>Kubernetes Command-Line Interface (kubectl)</li><li>Helm</li><li>kustomize</li></ul><h2 id=总结>总结</h2><p>Skaffold 确实让基于 Kubernetes 的开发者的本地工作环境更加优化和整洁了。希望本文对你的工作有所帮助。</p><a href=https://mp.weixin.qq.com/s/elRqbNlidJzmKCejBwtsAg target=_blank><img src=https://martinliu.cn/images/sref-zs.jpg alt="SRE Foundation 招生简章"></a></article><ul class="pager blog-pager"><li class=previous><a href=https://martinliu.cn/posts/build-security-in-elastic-stack/ data-toggle=tooltip data-placement=top title="Beats 摄入数据的最佳实践">&larr; 前一篇</a></li><li class=next><a href=https://martinliu.cn/posts/devopscoach-weekly-1/ data-toggle=tooltip data-placement=top title="DevOps Coach 周刊 #1">后一篇 &rarr;</a></li></ul><div><h2>See Also</h2><ul><li><a href=https://martinliu.cn/posts/devops-infrastructure-ci-app-deployment/>基础架构的持续集成和应用部署</a></li><li><a href=https://martinliu.cn/posts/download-import-vagrant-box/>如何在墙内正常导入 Vagrant 虚拟机模板</a></li><li><a href=https://martinliu.cn/posts/sre-sla-slo-sli/>SLA、SLO 和 SLI 还是傻傻分不清么？</a></li><li><a href=https://martinliu.cn/book/>出版书籍</a></li><li><a href=https://martinliu.cn/posts/2019-state-devops-report-insight-2/>怎样使用两个DevOps研究模型？</a></li></ul></div></div></div></section></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:liuzh66@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/martinliu title=GitHub><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/martinliu title=GitLab><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/martinliu title=Twitter><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/liuzheng title=LinkedIn><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">&copy;2017-2018
刘征 Martin Liu
&nbsp;&bull;&nbsp;
<a href=https://martinliu.cn/>Martin's Blog</a></p><p class="credits theme-by text-muted">由 <a href=http://gohugo.io>Hugo v0.80.0</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> 移植自 <a href=http://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://res.cloudinary.com/martinliu/raw/upload/static/bootstrap.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe-ui-default.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/auto-render.min.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/main.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/prism.js></script><script src=https://res.cloudinary.com/martinliu/raw/upload/static/katex.min.js></script><script>renderMathInElement(document.body);</script></body></html>
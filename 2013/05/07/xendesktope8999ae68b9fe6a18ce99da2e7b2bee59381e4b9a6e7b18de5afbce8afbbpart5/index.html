<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title> XenDesktop虚拟桌面精品书籍导读(part5) - Martin Liu&#39;s Blog</title>
  
  <meta property="og:title" content="XenDesktop虚拟桌面精品书籍导读(part5)" />
  <meta name="twitter:title" content="XenDesktop虚拟桌面精品书籍导读(part5)" />
  <meta name="description" content="[box color=&ldquo;orange&rdquo; icon=&ldquo;flag&rdquo;] 感谢 Eric Yao 的供稿，@老树皮Eric [/box] 今天是《Citrix Virtual Desktop Handbook》第二讲的最后一期，专门论述一下PVS的设计。在本期之后我会">
  <meta property="og:description" content="[box color=&ldquo;orange&rdquo; icon=&ldquo;flag&rdquo;] 感谢 Eric Yao 的供稿，@老树皮Eric [/box] 今天是《Citrix Virtual Desktop Handbook》第二讲的最后一期，专门论述一下PVS的设计。在本期之后我会">
  <meta name="twitter:description" content="[box color=&ldquo;orange&rdquo; icon=&ldquo;flag&rdquo;] 感谢 Eric Yao 的供稿，@老树皮Eric [/box] 今天是《Citrix Virtual Desktop Handbook》第二讲的最后一期，专门论述一下PVS的设计。在本期之后我会">
  <meta name="author" content="刘征 Martin Liu"/>
  <link href='https://martinliu.cn/favicon.ico' rel='icon' type='image/x-icon'/>

<meta name="msvalidate.01" content="12F570013342D1F8B60A455D09221C1D" />
<meta name="yandex-verification" content="7e9acc85531b0f35" />
<meta name="google-site-verification" content="4oSwNTpy1vzip3_lt6XhkhMfImCD_DZlvL3K1k-M8qk" />
<meta name="baidu-site-verification" content="Z7d1tYkxzQ" />

<script>(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
      'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
  })(window, document, 'script', 'dataLayer', 'GTM-TL37V8G');</script>


  <meta property="og:image" content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg" />
  <meta name="twitter:image" content="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@martinliu" />
  <meta name="twitter:creator" content="@martinliu" />
  <meta property="og:url" content="https://martinliu.cn/2013/05/07/xendesktope8999ae68b9fe6a18ce99da2e7b2bee59381e4b9a6e7b18de5afbce8afbbpart5/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Martin&#39;s Blog" />
  <meta name="keywords" content="" />

  <meta name="generator" content="Hugo 0.55.0-DEV" />
  <link rel="canonical" href="https://martinliu.cn/2013/05/07/xendesktope8999ae68b9fe6a18ce99da2e7b2bee59381e4b9a6e7b18de5afbce8afbbpart5/" />
  <link rel="alternate" href="https://martinliu.cn/index.xml" type="application/rss+xml" title="Martin&#39;s Blog">
  <script src="https://res.cloudinary.com/martinliu/raw/upload/static/jquery-1.12.4.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="https://martinliu.cn/css/main.css" />
  <link rel="stylesheet" href="https://martinliu.cn/css/search.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  



<link rel="stylesheet" href="https://martinliu.cn/css/prism.css" />


<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?50c3a9ae6c51222b31df5510bbca479f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-749876-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://martinliu.cn/">Martin&#39;s Blog</a>
    </div>
    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="首页" href="/">首页</a>
              
              
            </li>
          
        
          
            <li>
              <a title="标签" href="/tags">标签</a>
              
              
            </li>
          
        
          
            <li>
              <a title="关于" href="/about">关于</a>
              
              
            </li>
          
        
          
            <li>
              <a title="书籍" href="https://handbook.martinliu.cn">书籍</a>
              
              
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">搜索</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
          
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Martin&#39;s Blog" href="https://martinliu.cn/">
            <img class="avatar-img" src="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/avatar.jpg" alt="Martin&#39;s Blog" />
          </a>
        
      </div>
    </div>

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">全站搜索 by swiftype </h4>
        </div>
        <div class="modal-body">
            <style>
  .st-default-search-input {
    width: calc(100% - 45px);
  }
</style>
<div>
  <form>
    <input type="text" class="st-default-search-input" />
  </form>
</div>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','rvHKnQr8PJKjRDhyUWot','2.0.0');
</script>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="posts-heading">
                <h1 align="center">XenDesktop虚拟桌面精品书籍导读(part5)</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
    
  </header>


    
<div class="container" role="main">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            
            <div>
                <h5 id="wc">字数：8200 |大约阅读时间 17 分钟</h5>
                <h5 id="tags">标签: 
                    <a href="https://martinliu.cn//tags/citrix">Citrix</a> &nbsp;
                    <a href="https://martinliu.cn//tags/pvs">PVS</a> &nbsp;
                    <a href="https://martinliu.cn//tags/xendesktop">XenDesktop</a> &nbsp;
                </h5>

            </div>
            <article role="main" class="blog-post">
                <p>[box color=&ldquo;orange&rdquo; icon=&ldquo;flag&rdquo;]
感谢 Eric Yao 的供稿，<a href="http://weibo.com/ericyaozhen">@老树皮Eric</a>
[/box]</p>

<p>今天是<a href="http://support.citrix.com/article/CTX136546">《Citrix Virtual Desktop Handbook》</a>第二讲的最后一期，专门论述一下PVS的设计。在本期之后我会把所有以往的内容整合在一个完整的白皮书中，稍等几日。。。</p>

<p>请期待基于本系列5篇文章的完整版中文白皮书下载。</p>

<p>Citrix桌面虚拟化实施部署白皮书 第二讲之第五期：PVS的设计</p>

<ol>
<li>Provisioning Services</li>
</ol>

<p>Citrix Provisioning Services（PVS）使用流化的技术简化了虚拟桌面和物理桌面的部署。计算机从一个单个的共享磁盘镜像上被实时制备（Provisioned），管理员完全不需要去管理或者是给每个单独的用户操作系统打补丁。</p>

<p>**1)        *<strong><em>决断：</em></strong>*Farm*<strong><em>（场）的数量</em></strong>***</p>

<p>一个Provisioning Services的场代表着Provisioning Services基础架构的最高层级。所有在一个场的Provisioning Servers（服务器）都共享同一个SQL 数据库哦Citrix License服务器。当确定需要多少个Provisioning Services的场时，我们一般需要考虑以下几个因素：</p>

<p>l  <strong>网络：</strong>Provisioning Servers会始终和场数据库通信以获取系统配置信息。因此，一般来说每个target devices聚集的地理位置应该部署一个独立的场，当然，如果异地之间的网速足够快，理论上也可以只建立一个Provisioning Services场。</p>

<p>l  <strong>重要程度：</strong>管理者应该决定它可以容仍什么样的风险。尽管可能性非常的低，但是Provisioning Services场如果出问题还是会影响整个组织架构的使用。如果一个公司需要非常高等级的可用性，那么多个场的搭建就可以避免这个问题。</p>

<p>l  <strong>可管理性：</strong>管理者可能需要在基于组织架构划分的基础上，例如国家、地区，又或者是不同部门之间，来进行单独的系统管理。尽管听起来这会增加管理的复杂程度，但是实际上只会增加有限多的配置、桌面创建过程，以及操作系统镜像更新。</p>

<p>**2)        *<strong><em>决断：站点（</em></strong>*Sites*<strong><em>）的数量</em></strong>***</p>

<p>每个Provisioning Services的场都包含一个或者多个的站点。一个Provisioning Services的站点是一个逻辑的实体组成部分，包含了Provisioning Servers（服务器）、vDisk pools，以及target devices的集合。多个站点共享同一个数据库。Target devices可以在同一个站点中容错到其他的Provisioning Servers上。在以下的情况下我们建议创建多个站点：</p>

<p>l  <strong>网络：</strong>站点用来控制Provisioning Services的流数据量。例如，一个站点可以根据站点、rack、或者是刀箱来创建，以确保流数据始终保持在本地而不变成一个网络瓶颈。</p>

<p>l  <strong>组织架构：</strong>另外一个需要创建多个站点的实际理由是企业组织架构的改变。例如，两个公司通过收购合并了，但是有需要在企业整合过程中保持资源的独立。</p>

<p>3)         <strong>决断：数据库的配置</strong></p>

<p>Provisioning Services的数据库存储有所有一个场内的的系统配置信息。Provisioning Services 6.X版本支持一下版本的SQL数据库，包括Express、标准版、企业版的SQL Server 2005、2008R2以及2012版。选择哪一个SQL版本其实是取决于你需要哪一个级别的容错水平。以下的表格是一个SQL 2008R2版本的示例：</p>

<p>Provisioning Services场的数据库的大小很少会超过250M容量，即使在大型环境下也不会。所以，在测试环境下Express版本是最佳选择，因为不需要容错功能。</p>

<p>下面的公式是用来计算Provisioning Services的数据库的容量大小：</p>

<p>4)         <strong>决断：数据库；离线模式</strong></p>

<p>如果到Provisioning Services场的数据库的连接断开，已经连接到Provisioning Servers的target devices仍然可以正常工作，但是新的target devices将会无法启动。</p>

<p>支持离线数据库功能可以让Provisioning Services在失去连接到数据库后仍然可以保持正常操作。在服务器启动时会对数据库做个快照，然后定期保持同步。如果连接丢失，Stream Services会使用最新的一个快照以获取场的配置信息。一旦数据库连接建立起来了，Stream过程会把断线期间的变化同步到数据库中。</p>

<p><em>需要注意的是，离线数据库功能默认下是关闭状态的，而且也仅仅是在生产环境下的稳定的场环境下推荐使用。评估环境下不推荐使用</em></p>

<p>5)         <strong>决断：服务帐号</strong></p>

<p>Stream和SOAP服务会和其他许多不同的Provisioning Services基础架构中的组件进行通信，如下图所示：</p>

<p>6)         <strong>决断：设备集合</strong></p>

<p>设备集合是用来创建和管理target devices逻辑组。创建设备集合可以简化设备管理，因为将来的操作可以不用基于target device级别，而是基于集合这个级别。</p>

<p>设备集合可以基于物理地理位置、子网范围、组织架构中不同的部门来设计。也可以考虑基于vDisk的分配来创建不同的设备集合，这样所有分配到一个特定vDisk的所有的target devices就能被快速的定位。</p>

<p>7)         <strong>决断：</strong><strong>Provisioning Server</strong><strong>（服务器）的内存</strong></p>

<p>运行Provisioning Services的Windows操作系统会把vDisk的部分内容缓存在内存（系统缓存）中以降低从存储中读取的操作。从存储中读取数据的速度是显著低于从内存中读取数据的，所以，正确计算Provisioning Servers的内存是非常关键的。请参见以下的公式：</p>

<p>简单地说，就是给每个vDisk分配2G左右的内存。</p>

<p>8)         <strong>决断：</strong><strong>Scale Up</strong><strong>还是</strong><strong>Scale Out</strong></p>

<p><em>题外话：首先对这两个词进行一下解释：</em></p>

<p>_Scale Out(<strong>向外扩展)</strong>：就是指企业可以根据需求增加不同的服务器应用，依靠多部服务器协同运算，借负载平衡及容错等功能来提高运算能力及可靠度。_</p>

<p>_Scale Up(<strong>向上扩展)</strong>：指企业后端大型服务器以增加处理器等运算资源进行升级以获得对应用性能的要求。_</p>

<p>随着Farm场的增长，管理员需要作出决定以判断是不是需要给Provisioning Server增加更高的资源，也可以是在场中增加更加多的Provisioning Servers，一下了可以是考虑因素：</p>

<p>l  <strong>冗余：</strong>将用户符合扩展到其他负荷不重的服务器上会有助于降低当Provisioning Servers宕机情况下爱所影响的用户数量。如果公司无法接受单点高性能服务器宕机所造成的损失，那就考虑Scaling Out，就是我们说的向外扩展（既增加多台服务器）。</p>

<p>l  <strong>容错时间：</strong>在一个单台的Provisioning Server上所连接的Target Devices越多，在服务器宕机后所需要的恢复时间也就越多。Citrix的内部测试显示在Provisioning Services 5.6 SP2版本下，1500台Target Devices需要大约8分钟恢复生产能力；</p>

<p>l  <strong>数据中心容量：</strong>数据中心一般都是只有有限的空间、电源、冷却能力，此时，可以考虑Scaling Up，即向上扩展（增加单台服务器的处理能力）。</p>

<p>l  <strong>硬件成本：</strong>刚开始时，可能Scale Up会有更高的性价比，但是继续往后可能Scale Out会开始更具性价比，应该做一个成本分析；</p>

<p>9)         <strong>决断：</strong><strong>vDisk</strong><strong>的存储位置</strong></p>

<p>一个场可以包含一个或者多个的vDisk存储。一般来说有两个主要的选择：</p>

<p>l  <strong>本地存储或者是DAS</strong><strong>：</strong>DAS可以是本地的，或者是基于Block的存储类型，Provisioning Server可以直接访问，例如SATA、SCSI、iSCSI，以及光纤。本地的vDisk就只能被本地的Provisioning Server所反问，因此，vDisk应当被手动或者自动的复制到其他的vDisk存储位置上。</p>

<p><strong><em>注意：</em></strong>_将vDisk<strong>部署在本地存储上并不会造成单点故障，因为Provisioning Service</strong>的负载均衡技术可以让target devices<strong>自动的在其他Provisioning Servers</strong>之间做容错动作。_</p>

<p>l  <strong>NAS</strong><strong>：</strong>NAS是一种基于文件级存储的solution。NAS协议包括CIFS和NFS。NAS vDisk可以被多个Provisioning Server同时所访问。NAS由于不需要vDisk复制功能所以能保证vDisk在一个场内的多台Provisioning Server之间保持连续性。</p>

<p><strong><em>注意：</em></strong>_NAS<strong>反而会造成单点故障，如果网络共享功能不可用，所有从这个vDisk</strong>上Streamed<strong>的target device</strong>都会变得不可用了。_</p>

<p>10)     <strong>决断：评估存储容量</strong></p>

<p>一个vDisk包含了一个VHD基础镜像文件、一个properties文件（.pvd），也可以能包含了一个链条VHD差异磁盘（.avhd）。每当一个vDisk被Provisioning Services versioing所更新时，一个新的差异磁盘就会被创建。</p>

<p>一个vDisk所占空间的评估因素大致有以下几点：</p>

<p>l  <strong>vDisk</strong><strong>的总容量：</strong>顾名思义</p>

<p>l  <strong>vDisk chain</strong><strong>的最大版本数：</strong>vDisk versioning简化了vDisk升级以及管理的负担，他能够更加灵活和健壮的管理vDisks。</p>

<p><strong><em>备注：</em></strong>_太多的差异磁盘会显著降低Provisioning Services<strong>的性能，建议不要超过5-7</strong>个的版本数。_</p>

<p>l  <strong>vDisk</strong><strong>版本变化百分比：</strong>差异磁盘的大小是随着对vDisk的改动多少而随着变化的。改得越多，差异磁盘的大小就越大。以下的计算公式可以用于计算vDisk容量：</p>

<p>举例如下：</p>

<p>比如你计划部署三个vDisk：</p>

<p>  Windows 7 (x64) image = 40GB</p>

<p>  Windows 7 (x86) image = 35GB</p>

<p>  Windows XP image = 20GB</p>

<p>每个vDisk都不会超过5个差异磁盘。预计一个差异磁盘大致是20%的主vDisk镜像文件大小，那么估计Provisioning Services存储所需要的空间如下：</p>

<p>11)     <strong>决断：</strong><strong>RAID</strong><strong>级别</strong></p>

<p>存储子系统的RAID级别会对应用程序和用户的工作负荷产生直接的影响。RAID 0、1以及10对读操作是最优，而RAID 5和6是对写操作是最优。对于Provisioning Services来说，不同的RAID级别有如下推荐配置：</p>

<p>Provisioning Services中vDisk主要是读操作，而对Write Cache来说主要是写操作。所以：</p>

<p>l  <strong>Write Cache</strong><strong>：</strong>推荐RAID 0、1、10因为这几种RAID的写惩罚较低</p>

<p>l  **vDisk **<strong>存储：</strong>推荐RAID 0、1、5、10，它可以让读操作分配到RAID中的其他磁盘中；</p>

<p>如果可能，建议将vDisk放在RAID5上，而写缓存放在RAID10上。如果vDisk和写缓存一定要放在一起，那么建议采用RAID10。</p>

<p>12)     <strong>决断：写缓存的位置</strong></p>

<p>写缓存可以有以下位置：</p>

<p>l  <strong>缓存在Target Device</strong><strong>的硬盘上：</strong>由于Provisioning Servers不用处理写请求，放在这里会减轻Provisioning Servers的资源消耗。尽管没有放在内存中这么快，这种方式的读写都是在本地，还是能提供快速的响应时间；****</p>

<p>l  <strong>缓存在Target Device</strong><strong>的硬盘上永久保存：</strong>和第一种方式类似，区别在于用户重启之后存储永久保存。该功能目前还是测试阶段，仅在Windows 2008 R2和windows 7上支持。</p>

<p>l  <strong>缓存在Target Device</strong><strong>的内存中：</strong>尽管这种方式在性能上是最优的，但是如果RAM别耗尽了也会印象系统的稳定性；</p>

<p>l  <strong>缓存在Provisioning Server</strong><strong>的磁盘上：</strong>缓存在Provisioning Server的磁盘上作为临时文件存储。所有的写操作均发生在Provisioning Server服务器上。这样配置当然会增加Provisioning Server的磁盘IO操作和网络负担。配置上这种方式最为简单，不过这种方式下target device由于所有的到写缓存的读写请求都必须经过网络，target device的性能会受到较大影响。这种方式仅在POC阶段推荐！</p>

<p>l  <strong>缓存在Provisioning Server</strong><strong>的磁盘上永久保存：</strong>和上一种方式基本类似，区别在于用户重启之后存储永久保存。这种方式的好处在于target device能够保存对vDisk所做的改变，在重启之后也仍然保留。任何对vDisk的改变都会将缓存文件强制标记为失效状态。例如，如果vDisk被设置为Private Image Mode，一下所有的操作都会导致缓存文件被标记为失效状态：</p>

<p>n  o  Placing a vDisk in Maintenance mode</p>

<p>n  o  Mapping the drive from the console</p>

<p>n  o  Changing the location of the write cache file</p>

<p>n  o  Using Automatic update</p>

<p>写缓存包含了target device的MAC地址和磁盘识别符，他能独一无二的区分出每一台target device。一个target device可以被分配多个vDisk，因此，也可以关联多个缓存文件。</p>

<p>将写缓存部署在target device上是最为推荐的配置方法，因为既不用消耗而外的RAM内存，又不会减少Provisioning Servers的扩展性。</p>

<p>13)     <strong>决断：写缓存的大小</strong></p>

<p>写缓存的大小取决于很多隐私，一般来说都是基于评估和典型的用户配置文件大小。一般来说应当能够存储一下数据：</p>

<p>n  Temporary application data</p>

<p>n  User profile temp files</p>

<p>n  Windows Event Logs</p>

<p>n  Citrix Logs</p>

<p>n  Antivirus pattern files</p>

<p>n  Citrix Application Streaming/Microsoft App-V Cache</p>

<p><em>备注：启用了用户配置文件重定向操作能减少写缓存所需要的大小。</em></p>

<p>写缓存的大小极大程度上取决于安装或者是Streamed到vDisk上的应用程序的大小以及用户配置文件的大小。推荐配置的起点是2GB。对于大部分虚拟桌面来说，我们有如下推荐配置：</p>

<p>此外，Windows的pagefile也会写入和写缓存同样的磁盘中，所以：</p>

<p>例如，如果Windows 7的vDisk设计是1.5GB的pagefile，那么写缓存的一个安全的评估数据应该是：</p>

<p>不过由于Hypervisor都不能将磁盘精确到小数点后，我们姑且分配4GB的空间吧。</p>

<p>14)     <strong>决断：</strong><strong>vDisk</strong><strong>的格式</strong></p>

<p>Provisioning Services支持固定磁盘以及动态磁盘格式。</p>

<p>l  <strong>固定磁盘格式：</strong>对于私有模式（private mode）的vDisk，固定尺寸大小的vDisk可以对存储vDisk磁盘上进行的磁盘碎片整理操作，这对写操作的性能提升会有帮助。不过在私有模式下，访问vDisk受限于一个target device，我们说仅当对vDisk进行维护模式时才有实际意义。</p>

<p>l  <strong>动态磁盘：</strong>相比较而言他需要更少的磁盘空间，但是在写操作上性能会显著降低。尽管在共享模式下（Shared Mode）的vDisk不会对vDisk执行写操作，不过对完成vDisk合并时所要花费的时间会增加许多。</p>

<p>15)     <strong>决断：</strong><strong>vDisk</strong><strong>的大小</strong></p>

<p>vDisk的大小主要取决于操作系统以及安装在操作系统上的应用程序的多少，我们预估的大小如下表所示：</p>

<p>vDisk的大小如果设置的太小或者是太大，日后我们还可以在Provisioning Services中调整。为了精确的评估vDisk的大小，请遵循以下的准则：</p>

<p>l  <strong>Target Device</strong><strong>的空间：</strong>确认目前作为主target device服务的计算机所正在使用的磁盘空间大小；****</p>

<p>l  <strong>应用程序大小：</strong>当应用程序安装时，所需要的空间也在增长。计划大25%的增长</p>

<p>16)     <strong>决断：</strong><strong>vDisk</strong><strong>复制</strong></p>

<p>如果vDisk是存储在DAS上就需要在他自己有变化的时候复制到其他DAS上。Provisioning Services支持vDisk从本地复制到Provisioning Servers上，也可以支持在使用共享存储时跨越多个站点之间的复制。复制可以是手动或者是自动：</p>

<p>l  <strong>手动复制：</strong>简单，但是更耗时；</p>

<p>l  <strong>自动复制：</strong>大型环境下自动复制更快。一些自动化工具，例如Microsoft DFS-R还支持带宽控制。唯一缺点是如果复制出错，管理员还不支持，除非复制平台支持复制重传。</p>

<p>17)     <strong>决断：微软</strong><strong>Volume Licensing</strong></p>

<p>Provisioning Services支持Microsoft Key Management Service (KMS)和Multiple Activation Key (MAK) volume licensing。</p>

<p>l  <strong>KMS Volume Licensing</strong><strong>：</strong>可以在用户的本地网络上激活，无需连接到微软的网站。一台KMS服务器支持不受限的JMS客户端。微软公司推荐部署两台KMS服务器。****</p>

<p>n  Office 2010的部署只支持KSM激活方式；</p>

<p>l  <strong>MAK Volume Licensing</strong><strong>：</strong>MS的一次性激活方式。</p>

<p>18)     <strong>决断：高可用</strong></p>

<p>Provisioning Services是虚拟桌面基础架构中最重要的组成部分，因此为了避免单点故障，需要考虑一下推荐步骤：</p>

<p>l  <strong>MAK Volume Licensing</strong><strong>：</strong>MS的一次性激活方式。</p>

<p>l  <strong>数据库：</strong>Provisioning Services支持两种数据库的高可用方式：</p>

<p>n  离线的数据库；</p>

<p>n  镜像数据库</p>

<p>l  <strong>Provisioning Servers</strong><strong>（PVS</strong><strong>服务器）：</strong>所有在一个站点之间的Provisioning Servers都能够被配置为向target device提供同一个vDisk。每个站点最少部署两台PVS服务器。</p>

<p>n  Provisioning Services启动文件应当配置为高可用。在启动文件中可以配置高达4台PVS服务器的列表。Target Device会按照顺序连接这些PVS服务器。后续所响应的服务器可以不是当初提供Streaming服务的服务器。当然，我们也可以配置负载均衡。</p>

<p>l  <strong>vDisk</strong><strong>和存储：</strong>对于DAS上存储的vDisk，应当做好同步操作。对于NAS上的vDisk，NAS存储必须提供一条高可用的网络共享连接；</p>

<p>l  <strong>网络：</strong>Provisioning Servers（PVS服务器）的网卡应当配置为Teamed。</p>

<p>19)     <strong>决断：带宽需求</strong></p>

<p>带宽评估对于整体性能是有至关重要的，特别是当Target Device启动的时候。带宽是随着操作系统的不同而有所区别的。Target Device启动所需要的时间可以参考下面的公式：</p>

<p>例如，500个Windows 7的Target Devices在1G以太网下需要40M启动：</p>

<p>1.  1 GB Ethernet = 125MB/s</p>

<p>2.  500 targets x 40 MB = 20GB</p>

<p>3.  20GB/125MBs = 160 seconds</p>

<p>下面的表格列举了在10GB网络下启动500台不同操作系统的Target Device时大致的带宽和启动加载时间：</p>

<p>备注：防火墙会增加网络延迟，同时也会造成网络瓶颈，如果可能，最好禁用防火墙，如果实在不能避免，最好能开放一下端口的完全访问能力：</p>

<p>20)     <strong>决断：网络配置</strong></p>

<p>为PVS服务器提供10Gbps网络能提供最够需要的带宽，如果做不到的话，1Gbps也可以提供足够的带宽，但是有可能会成为PVS服务器的瓶颈。将多块网卡做Teaming处理能提供更高的吞吐量，增加网络性能，也能阻止网络的单点故障。下表列出了PVS服务器的网络配置属性，从最大容量到最小：</p>

<p>以下的NIC属性应当正确配置在PVS服务器以及Target Devices的NIC上：</p>

<p>简单地说，就是禁用Checksum Offloading属性；关闭Auto Negotiation，使用强制配置；启用Jumbo Frame。</p>

<p>21)     <strong>决断：交换机配置</strong></p>

<p>用于PVS服务器和Target Devices的网络交换机应当做一下优化：</p>

<p>l  <strong>生成树协议（Spanning Tree Protocol</strong><strong>）/PortFast</strong><strong>：</strong>禁用生成树协议，启用PortFast；</p>

<p>l  <strong>风暴控制 Storm Control</strong><strong>：</strong>在Cisco Catalyst交换机上将Unicast流量值设置大一些，或者是禁用Unicast Filtering。</p>

<p>l  <strong>Broadcast Helper</strong><strong>：</strong>启用之，这样可以转发PXE和TFTP流量；</p>

<p>22)     <strong>决断：</strong><strong>Bootstrap</strong><strong>交付</strong></p>

<p>在一个Target Device开始启动过程的时候，他会首先加载一个bootstrap程序，该程序会初始化Target Device和PVS服务器之间的流化会话过程。有三种方法让Target Device能收到bootstrap程序：</p>

<p>l  <strong>Broadcast Helper</strong><strong>：</strong>启用之，这样可以转发PXE和TFTP流量；</p>

<p>l  <strong>使用带有DHCP</strong><strong>选项的PXE</strong><strong>方式；</strong></p>

<p>l  <strong>使用不带有DHCP</strong><strong>选项的PXE</strong><strong>方式；</strong></p>

<p>l  <strong>使用Boot Device Manager</strong><strong>；</strong></p>

<p>在企业无法提供PXE或者是TFTP服务的情况下，或者是无法对DHCP Scope选项修改的情况下，可以考虑使用Boot Device Management工具通过一个ISO文件来提供bootstrap文件。</p>

<p>23)     <strong>决断：审计</strong></p>

<p>默认下审计功能是禁用的，管理员可以将将其打开。打开后该工具可以记录在Provisioning Services场内组件所做的配置修改记录，并将结果记录至数据库中。</p>

<p>24)     <strong>决断：防病毒</strong></p>

<p>大部分的防病毒软件都会是扫描所有的文件和系统进程，对性能影响很大。所以在PVS环境下必须优化防病毒软件的配置。请参见CTX124185 - Provisioning Services Antivirus Best Practices。</p>

                    <a href="http://zhihu.com/people/devopscoach" target="_blank">
                    <img src="https://res.cloudinary.com/martinliu/image/upload/q_auto:eco/martin-at-zhihu.png" alt="DevOps教练在知乎" />
                    </a>
            </article>
            

            <ul class="pager blog-pager">
                
                <li class="previous">
                    <a href="https://martinliu.cn/2013/05/07/top10e585a8e79083e68e92e5908de5898de58d81e79a84e4ba91e8aea1e7ae97e585ace58fb8/" data-toggle="tooltip" data-placement="top" title="Top10全球排名前十的云计算公司">&larr; 前一篇</a>
                </li>
                 
                <li class="next">
                    <a href="https://martinliu.cn/2013/05/14/hide-windows-explorer-items/" data-toggle="tooltip" data-placement="top" title="隐藏Windows  Explorer中的各种东西">后一篇 &rarr;</a>
                </li>
                
            </ul>
            <div>
                 
                <h2>See Also</h2>
                <ul>
                    
                    <li>
                        <a href="/2013/05/02/xendesktope8999ae68b9fe6a18ce99da2e7b2bee59381e4b9a6e7b18de5afbce8afbbpart4/">XenDesktop虚拟桌面精品书籍导读(part4)</a>
                    </li>
                    
                    <li>
                        <a href="/2013/05/02/ask-the-architect-e68ea8e88d90citrixe8999ae68b9fe58c96e5a4a7e5b888e4b880e5908d/">Ask the Architect 推荐Citrix虚拟化大师一名</a>
                    </li>
                    
                    <li>
                        <a href="/2013/04/16/xendesktope8999ae68b9fe6a18ce99da2e7b2bee59381e4b9a6e7b18de5afbce8afbbpart3/">XenDesktop虚拟桌面精品书籍导读(part3)</a>
                    </li>
                    
                    <li>
                        <a href="/2013/05/07/top10e585a8e79083e68e92e5908de5898de58d81e79a84e4ba91e8aea1e7ae97e585ace58fb8/">Top10全球排名前十的云计算公司</a>
                    </li>
                    
                    <li>
                        <a href="/2013/04/23/xen-is-now-a-linux-foundation-collaborative-project/">让Xen Project回家</a>
                    </li>
                    
                </ul>
                
            </div>
            

            
            

        </div>
    </div>
    </section>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:liuzh66@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/&#43;MartinLiu-cn" title="Google&#43;">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/martinliu" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/martinliu" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/liuzheng" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
        &copy;2017-2018

              刘征 Martin Liu

          
          
            &nbsp;&bull;&nbsp;
            <a href="https://martinliu.cn/">Martin&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          由 <a href="http://gohugo.io">Hugo v0.55.0-DEV</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> 移植自 <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>

        <p class="credits theme-by text-muted">
          全站搜索来自于 <a href="https://swiftype.com/"> swiftype.com </a>
        </p>

      </div>
    </div>
  </div>
</footer>


<script src="https://res.cloudinary.com/martinliu/raw/upload/static/bootstrap.min.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe-ui-default.min.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/photoswipe.min.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/auto-render.min.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/main.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/prism.js"></script>
<script src="https://res.cloudinary.com/martinliu/raw/upload/static/katex.min.js"></script>
<script> renderMathInElement(document.body); </script>








  </body>
</html>

